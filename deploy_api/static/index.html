<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Dashboard</title>
    <style>
        :root {
            --bg: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .header h1 { font-size: 1.25rem; font-weight: 600; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title { font-size: 1rem; font-weight: 600; }
        
        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.875rem;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover { background: var(--bg-input); }
        .btn-sm { padding: 6px 12px; font-size: 0.75rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: rgba(34, 197, 94, 0.15); color: #16a34a; }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: #d97706; }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: #dc2626; }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
        }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab:hover { color: var(--text); }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            padding: 12px 16px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .auth-card { width: 100%; max-width: 400px; }
        .auth-title { text-align: center; margin-bottom: 24px; }
        .auth-title h1 { font-size: 1.5rem; margin-bottom: 8px; }
        .auth-title p { color: var(--text-muted); }
        
        .server-item {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: background 0.15s;
        }
        .server-item:hover {
            background: var(--bg-card);
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .server-name { font-weight: 600; }
        .server-details {
            display: flex;
            gap: 16px;
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .server-ip {
            font-family: monospace;
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        /* Log container */
        .log-container {
            background: #1e293b;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            color: #e2e8f0;
        }
        .log-line { margin-bottom: 4px; line-height: 1.4; }
        .log-line.info { color: #60a5fa; }
        .log-line.success { color: #4ade80; }
        .log-line.error { color: #f87171; }
        .log-line.warning { color: #fbbf24; }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: var(--bg-card);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        .modal-body { padding: 20px; }
        
        /* Source type radio buttons - pill style */
        .source-radio-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .source-radio {
            display: none;
        }
        .source-radio + label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }
        .source-radio + label:hover {
            border-color: var(--primary);
            background: var(--bg-card);
        }
        .source-radio:checked + label {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Number spinner with +/- buttons */
        .number-spinner {
            display: inline-flex;
            align-items: center;
            gap: 0;
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            background: white;
        }
        .number-spinner button {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-input);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            color: var(--text);
            transition: background 0.15s;
        }
        .number-spinner button:hover {
            background: var(--border);
        }
        .number-spinner button:active {
            background: var(--primary);
            color: white;
        }
        .number-spinner input {
            width: 50px;
            height: 32px;
            border: none;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            text-align: center;
            font-size: 0.9rem;
            background: white;
            -moz-appearance: textfield;
        }
        .number-spinner input::-webkit-outer-spin-button,
        .number-spinner input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Collapsible section */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }
        .collapsible-header:hover {
            background: var(--bg-card);
        }
        .collapsible-content {
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }
        .collapse-icon {
            transition: transform 0.3s;
        }
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div id="modals"></div>
    
    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="card auth-card">
                <div class="auth-title">
                    <h1>üöÄ Deploy Dashboard</h1>
                    <p>Sign in to manage your infrastructure</p>
                </div>
                
                <div class="tabs" style="border-bottom: none; margin-bottom: 16px; justify-content: center;">
                    <button class="tab active" onclick="showAuthTab('login')">Sign In</button>
                    <button class="tab" onclick="showAuthTab('signup')">Sign Up</button>
                </div>
                
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </form>
                
                <form id="signup-form" class="hidden" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signup-email" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signup-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
                </form>
                
                <p id="auth-error" class="hidden" style="color: var(--danger); margin-top: 12px; text-align: center;"></p>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="app-screen" class="hidden">
        <header class="header">
            <h1>üöÄ Deploy Dashboard</h1>
            <div class="header-actions">
                <span id="user-email" style="color: var(--text-muted);"></span>
                <button class="btn btn-ghost btn-sm" onclick="logout()">Logout</button>
            </div>
        </header>
        
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('infra')">Infrastructure</button>
                <button class="tab" onclick="showTab('deploy')">Deploy</button>
                <button class="tab" onclick="showTab('architecture')">Architecture</button>
                <button class="tab" onclick="showTab('logs')">Logs</button>
                <button class="tab" onclick="showTab('snapshots')">Snapshots</button>
                <button class="tab" onclick="showTab('services')">Services</button>
                <button class="tab" onclick="showTab('settings')">Settings</button>
            </div>
            
            <!-- Infrastructure Tab -->
            <div id="tab-infra">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üñ•Ô∏è Servers</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="server-project-filter" style="width: 140px; padding: 4px 8px; font-size: 0.85rem;" onchange="loadServers()">
                                    <option value="">All Projects</option>
                                </select>
                                <button class="btn btn-success btn-sm" onclick="showProvisionModal()">+ New</button>
                            </div>
                        </div>
                        <div id="server-list">
                            <div class="empty-state"><p>Loading...</p></div>
                        </div>
                        <button class="btn btn-ghost btn-sm" onclick="loadServers()" style="margin-top: 12px;">‚Üª Refresh</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">‚ö° Quick Actions</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button class="btn btn-primary" onclick="showProvisionModal()">üöÄ Provision New Server</button>
                            <button class="btn btn-ghost" onclick="loadSnapshots(); showTab('snapshots');">üì∏ Manage Snapshots</button>
                            <button class="btn btn-ghost" onclick="showTab('settings')">‚öôÔ∏è Configure DO Token</button>
                        </div>
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div class="card-title" style="margin-bottom: 12px;">üìä Status</div>
                            <div id="status-info" style="font-size: 0.875rem; color: var(--text-muted);">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Deploy Tab -->
            <div id="tab-deploy" class="hidden">
                <!-- TODO Box -->
                <div class="card" style="margin-bottom: 16px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div class="card-header" style="padding: 12px 16px;">
                        <span class="card-title" style="font-size: 0.9rem;">üöß TODO</span>
                    </div>
                    <ul style="margin: 0; padding: 8px 16px 12px 32px; font-size: 0.85rem; color: var(--text-muted);">
                        <li style="text-decoration: line-through; opacity: 0.6;">Use existing servers that match selected snapshot</li>
                        <li style="text-decoration: line-through; opacity: 0.6;">Handle different environments (dev/staging/prod)</li>
                        <li>Save deployment config to DB (for redeploys, rollbacks)</li>
                        <li>Add domain/SSL configuration</li>
                        <li style="color: var(--danger);">‚ö†Ô∏è Remove EMERGENCY_ADMIN_IPS from cloudinit.py before real clients</li>
                    </ul>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üöÄ Deploy Application</span>
                        </div>
                        <form id="deploy-form" onsubmit="startDeployment(event)">
                            <div style="display: flex; gap: 12px;">
                                <div class="form-group" style="flex: 2;">
                                    <label>App Name *</label>
                                    <input type="text" id="deploy-name" placeholder="my-app" required pattern="[a-z0-9-]+" title="Lowercase letters, numbers, hyphens only">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Project</label>
                                    <input type="text" id="deploy-project" placeholder="my-project" pattern="[a-z0-9-]*" title="Lowercase letters, numbers, hyphens only">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Environment</label>
                                    <select id="deploy-environment">
                                        <option value="dev">dev</option>
                                        <option value="test">test</option>
                                        <option value="staging">staging</option>
                                        <option value="uat">uat</option>
                                        <option value="prod" selected>prod</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Tags <small style="color: var(--text-muted);">(comma-separated)</small></label>
                                <input type="text" id="deploy-tags" placeholder="api, backend, v2">
                            </div>
                            
                            <div class="form-group">
                                <label>Source Type *</label>
                                <div class="source-radio-group">
                                    <input type="radio" name="deploy-source" value="code" id="source-code" class="source-radio" checked onchange="toggleDeploySource()">
                                    <label for="source-code">üìÅ Local Code</label>
                                    
                                    <input type="radio" name="deploy-source" value="git" id="source-git" class="source-radio" onchange="toggleDeploySource()">
                                    <label for="source-git">üì¶ Git Repo</label>
                                    
                                    <input type="radio" name="deploy-source" value="image" id="source-image" class="source-radio" onchange="toggleDeploySource()">
                                    <label for="source-image">üê≥ Registry</label>
                                    
                                    <input type="radio" name="deploy-source" value="image_file" id="source-image-file" class="source-radio" onchange="toggleDeploySource()">
                                    <label for="source-image-file">üì¶ Local Image</label>
                                </div>
                            </div>
                            
                            <div id="deploy-source-code">
                                <div class="form-group">
                                    <label>Code *</label>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <button type="button" class="btn btn-sm" id="btn-select-zip" onclick="selectCodeZip()" style="flex: 1;">
                                            üì¶ Select ZIP/tar.gz
                                        </button>
                                        <button type="button" class="btn btn-sm btn-ghost" id="btn-select-folder" onclick="selectCodeFolder()" style="flex: 1;">
                                            üìÅ Select Folder
                                        </button>
                                    </div>
                                    <input type="file" id="deploy-file" accept=".zip,.tar.gz,.tgz" style="display: none;" onchange="onCodeFileSelected(this)">
                                    <input type="file" id="deploy-folder" webkitdirectory directory multiple style="display: none;" onchange="onCodeFolderSelected(this)">
                                    <div id="code-selection-info" style="padding: 8px; background: var(--bg-input); border-radius: 4px; font-size: 0.85rem; color: var(--text-muted);">
                                        No code selected
                                    </div>
                                </div>
                                
                                <!-- Dockerfile Preview (shown after file selected) -->
                                <div id="dockerfile-preview" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <label style="margin: 0;">
                                            üê≥ Dockerfile
                                            <span id="dockerfile-preview-badge" class="badge badge-info" style="margin-left: 8px; font-size: 0.7rem;"></span>
                                        </label>
                                        <button type="button" class="btn btn-ghost btn-sm" onclick="toggleDockerfilePreview()">‚ñº</button>
                                    </div>
                                    <div id="dockerfile-preview-content">
                                        <textarea id="dockerfile-editor-preview" 
                                            style="width: 100%; height: 180px; font-family: monospace; font-size: 12px; 
                                                   background: var(--bg-input); border: 1px solid var(--border); 
                                                   border-radius: 4px; padding: 12px; resize: vertical;"
                                            spellcheck="false" placeholder="Loading..."></textarea>
                                        <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                            <select id="dockerfile-quick-from" style="flex: 1; min-width: 150px;" onchange="updateDockerfilePreviewField('from')">
                                                <option value="">FROM...</option>
                                                <option value="python:3.11-slim">python:3.11-slim</option>
                                                <option value="python:3.12-slim">python:3.12-slim</option>
                                                <option value="node:20-alpine">node:20-alpine</option>
                                                <option value="node:18-alpine">node:18-alpine</option>
                                                <option value="golang:1.21-alpine">golang:1.21-alpine</option>
                                                <option value="nginx:alpine">nginx:alpine</option>
                                            </select>
                                            <input type="text" id="dockerfile-quick-cmd" placeholder="CMD (e.g. uvicorn main:app ...)" 
                                                   style="flex: 3; min-width: 250px;" onchange="updateDockerfilePreviewField('cmd')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="deploy-source-git" style="display: none;">
                                <div class="form-group">
                                    <label>Git Repository URL *</label>
                                    <input type="url" id="deploy-git-url" placeholder="https://github.com/user/repo">
                                    <small style="color: var(--text-muted);">HTTPS URL (SSH not supported)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Branch</label>
                                    <input type="text" id="deploy-git-branch" value="main" placeholder="main">
                                </div>
                                
                                <details style="margin-bottom: 16px;">
                                    <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.85rem;">üîê Private repository?</summary>
                                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                                        <div class="form-group" style="margin-bottom: 0;">
                                            <label>Personal Access Token</label>
                                            <input type="password" id="deploy-git-token" placeholder="ghp_xxxxxxxxxxxx">
                                            <small style="color: var(--text-muted);">
                                                GitHub: Settings ‚Üí Developer settings ‚Üí Personal access tokens<br>
                                                GitLab: Settings ‚Üí Access Tokens<br>
                                                Needs <code>repo</code> scope for private repos
                                            </small>
                                        </div>
                                    </div>
                                </details>
                            </div>
                            
                            <div id="deploy-source-image" style="display: none;">
                                <div class="form-group">
                                    <label>Server *</label>
                                    <select id="deploy-server">
                                        <option value="">Select a server...</option>
                                    </select>
                                    <small style="color: var(--text-muted);">Deploy to existing server, or provision new one below</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Docker Image *</label>
                                    <input type="text" id="deploy-image" placeholder="registry.digitalocean.com/my-registry/app:latest">
                                    <small style="color: var(--text-muted);">Full image URL from DO Registry or Docker Hub</small>
                                </div>
                                
                                <details style="margin-bottom: 16px;">
                                    <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.85rem;">+ Provision new server instead</summary>
                                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                                        <div class="form-group">
                                            <label>Snapshot</label>
                                            <select id="deploy-image-snapshot">
                                                <option value="">Select a snapshot...</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Region</label>
                                            <select id="deploy-image-region">
                                                <option value="lon1">London</option>
                                                <option value="nyc1">New York</option>
                                                <option value="sfo1">San Francisco</option>
                                                <option value="ams3">Amsterdam</option>
                                                <option value="sgp1">Singapore</option>
                                                <option value="fra1">Frankfurt</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Size</label>
                                            <select id="deploy-image-size">
                                                <option value="s-1vcpu-1gb">1 vCPU, 1 GB ($6/mo)</option>
                                                <option value="s-1vcpu-2gb">1 vCPU, 2 GB ($12/mo)</option>
                                                <option value="s-2vcpu-2gb">2 vCPU, 2 GB ($18/mo)</option>
                                                <option value="s-2vcpu-4gb">2 vCPU, 4 GB ($24/mo)</option>
                                            </select>
                                        </div>
                                    </div>
                                </details>
                            </div>
                            
                            <div id="deploy-source-image-file" style="display: none;">
                                <div class="form-group">
                                    <label>Docker Image File (.tar) *</label>
                                    <input type="file" id="deploy-image-file" accept=".tar" onchange="onImageFileSelected(this)">
                                    <small style="color: var(--text-muted);">
                                        Build locally, then export: <code>docker save myapp -o myapp.tar</code>
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label>Image Name</label>
                                    <input type="text" id="deploy-image-file-name" placeholder="(auto-detected from tar)" readonly 
                                           style="background: var(--bg-secondary);">
                                    <small id="deploy-image-file-name-hint" style="color: var(--text-muted);">Will be detected from tar file</small>
                                </div>
                                <div style="display: flex; gap: 16px;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Container Port</label>
                                        <input type="number" id="deploy-image-file-container-port" value="8000" min="1" max="65535" readonly
                                               style="background: var(--bg-secondary);">
                                        <small style="color: var(--text-muted);">Detected from image EXPOSE</small>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Host Port</label>
                                        <input type="number" id="deploy-image-file-host-port" value="8000" min="1" max="65535">
                                        <small style="color: var(--text-muted);">External port to access app</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="deploy-app-port-section" class="form-group">
                                <label>App Port</label>
                                <input type="number" id="deploy-port" value="8000" min="1" max="65535" onchange="updateDockerfilePort()">
                                <small style="color: var(--text-muted);">Port your app listens on inside the container</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Environment Variables</label>
                                <textarea id="deploy-env" rows="3" placeholder="KEY=value&#10;ANOTHER_KEY=value"></textarea>
                                <small style="color: var(--text-muted);">One per line: KEY=value</small>
                            </div>
                            
                            <!-- Service Discovery & Persistence -->
                            <div id="deploy-service-config" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                                    <span style="font-size: 1.1rem;">üîß</span>
                                    <span style="font-weight: 600;">Service Configuration</span>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="deploy-auto-env" style="width: auto;">
                                        <span>Auto-inject service discovery</span>
                                    </label>
                                    <small style="color: var(--text-muted); display: block; margin-left: 24px;">
                                        Injects DATABASE_URL, REDIS_URL, etc. based on dependencies
                                    </small>
                                </div>
                                
                                <div id="deploy-dependencies-section" style="margin-bottom: 12px; padding: 12px; background: var(--bg-card); border-radius: 6px; display: none;">
                                    <label style="font-size: 0.85rem; margin-bottom: 8px; display: block;">Dependencies (services this app needs)</label>
                                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                            <input type="checkbox" class="deploy-dep" value="postgres" style="width: auto;">
                                            <span>üêò PostgreSQL</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                            <input type="checkbox" class="deploy-dep" value="redis" style="width: auto;">
                                            <span>‚ö° Redis</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                            <input type="checkbox" class="deploy-dep" value="mongo" style="width: auto;">
                                            <span>üçÉ MongoDB</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                            <input type="checkbox" class="deploy-dep" value="mysql" style="width: auto;">
                                            <span>üê¨ MySQL</span>
                                        </label>
                                    </div>
                                    <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                                        Will inject: DB_HOST, DB_PORT, DATABASE_URL, REDIS_URL, etc.
                                    </small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="deploy-persist-data" style="width: auto;">
                                        <span>Persist data</span>
                                    </label>
                                    <small style="color: var(--text-muted); display: block; margin-left: 24px;">
                                        Mounts /data volume for SQLite, uploads, etc. (survives redeploys)
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Domain Configuration -->
                            <div id="deploy-domain-section" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                                    <span style="font-size: 1.1rem;">üåê</span>
                                    <span style="font-weight: 600;">Domain & Routing</span>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="deploy-setup-domain" style="width: auto;" onchange="onSetupDomainChange()">
                                        <span>Auto-provision domain</span>
                                    </label>
                                    <small style="color: var(--text-muted); display: block; margin-left: 24px;">
                                        Creates DNS record and nginx routing (requires Cloudflare token in Settings)
                                    </small>
                                </div>
                                
                                <div id="deploy-domain-details" style="display: none; padding: 12px; background: var(--bg-card); border-radius: 6px;">
                                    <div style="margin-bottom: 8px;">
                                        <label style="font-size: 0.85rem;">Domain Preview:</label>
                                        <div id="deploy-domain-preview" style="font-family: monospace; color: var(--primary); padding: 8px; background: var(--bg-input); border-radius: 4px; margin-top: 4px;">
                                            {service}-{project}-{env}.digitalpixo.com
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 8px;">
                                        <label style="font-size: 0.85rem;">Base Domain</label>
                                        <input type="text" id="deploy-base-domain" value="digitalpixo.com" onchange="updateDomainPreview()">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="font-size: 0.85rem;">Custom Aliases (optional)</label>
                                        <input type="text" id="deploy-domain-aliases" placeholder="api.myclient.com, app.example.com">
                                        <small style="color: var(--text-muted);">Comma-separated. Client domains need DNS pointed to your servers.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Infrastructure: Snapshot, Region, Size, Servers -->
                            <div id="deploy-infra-section" style="border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                                    <span style="font-size: 1.1rem;">üñ•Ô∏è</span>
                                    <span style="font-weight: 600;">Infrastructure</span>
                                </div>
                                
                                <div class="form-group">
                                    <label>Snapshot</label>
                                    <select id="deploy-snapshot" onchange="onSnapshotChange()">
                                        <option value="">Select a snapshot...</option>
                                    </select>
                                    <small style="color: var(--text-muted);">Base image for new servers</small>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label>Region</label>
                                        <select id="deploy-region" onchange="onInfraChange()">
                                            <option value="lon1">üá¨üáß London</option>
                                            <option value="nyc1">üá∫üá∏ New York</option>
                                            <option value="sfo1">üá∫üá∏ San Francisco</option>
                                            <option value="ams3">üá≥üá± Amsterdam</option>
                                            <option value="sgp1">üá∏üá¨ Singapore</option>
                                            <option value="fra1">üá©üá™ Frankfurt</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label>Size</label>
                                        <select id="deploy-size" onchange="onInfraChange()">
                                            <option value="s-1vcpu-1gb">1 vCPU / 1 GB ($6)</option>
                                            <option value="s-1vcpu-2gb">1 vCPU / 2 GB ($12)</option>
                                            <option value="s-2vcpu-2gb">2 vCPU / 2 GB ($18)</option>
                                            <option value="s-2vcpu-4gb">2 vCPU / 4 GB ($24)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Servers -->
                                <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; overflow: hidden;">
                                    <div class="collapsible-header" onclick="toggleServerList()">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-weight: 500; font-size: 0.9rem;">üñ•Ô∏è Existing Servers</span>
                                            <span id="deploy-server-count" class="badge badge-info" style="font-size: 0.7rem;">0 selected</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <button type="button" class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); selectAllServers(true)" title="Select all">‚úì All</button>
                                            <button type="button" class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); selectAllServers(false)" title="Unselect all">‚úï None</button>
                                            <span class="collapse-icon">‚ñº</span>
                                        </div>
                                    </div>
                                    <div id="deploy-server-list" class="collapsible-content">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <tbody id="deploy-server-tbody">
                                                <tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-muted);">Loading...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--bg-input); border-top: 1px solid var(--border);">
                                        <span style="font-size: 0.85rem;">‚ûï New servers:</span>
                                        <div class="number-spinner">
                                            <button type="button" onclick="adjustServerCount(-1)">‚àí</button>
                                            <input type="number" id="deploy-additional-servers" value="0" min="0" max="10">
                                            <button type="button" onclick="adjustServerCount(1)">+</button>
                                        </div>
                                        <small style="color: var(--text-muted); margin-left: auto;">Uses snapshot above</small>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                üöÄ Deploy
                            </button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üìã Deployment Progress</span>
                        </div>
                        <div id="deploy-progress" style="display: none;">
                            <div class="progress-bar" style="margin-bottom: 16px;">
                                <div id="deploy-progress-bar" class="progress-fill" style="width: 0%;"></div>
                            </div>
                            <!-- Dockerfile Review (shown mid-flow for git deploys) -->
                            <div id="deploy-dockerfile-review" style="display: none; margin-bottom: 16px; padding: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span style="font-weight: 600;">üê≥ Review Dockerfile <span id="dockerfile-review-badge" class="badge badge-info" style="font-size: 0.7rem;"></span></span>
                                </div>
                                <textarea id="dockerfile-review-editor" 
                                    style="width: 100%; height: 160px; font-family: monospace; font-size: 12px; 
                                           background: var(--bg-input); border: 1px solid var(--border); 
                                           border-radius: 4px; padding: 12px; resize: vertical; margin-bottom: 12px;"
                                    spellcheck="false"></textarea>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                                    <select id="dockerfile-review-from" style="flex: 1; min-width: 140px;" onchange="updateDockerfileReviewField('from')">
                                        <option value="">FROM...</option>
                                        <option value="python:3.11-slim">python:3.11-slim</option>
                                        <option value="python:3.12-slim">python:3.12-slim</option>
                                        <option value="node:20-alpine">node:20-alpine</option>
                                        <option value="node:18-alpine">node:18-alpine</option>
                                        <option value="golang:1.21-alpine">golang:1.21-alpine</option>
                                        <option value="nginx:alpine">nginx:alpine</option>
                                    </select>
                                    <input type="text" id="dockerfile-review-cmd" placeholder="CMD" 
                                           style="flex: 3; min-width: 250px;" onchange="updateDockerfileReviewField('cmd')">
                                </div>
                                <button id="dockerfile-review-continue" class="btn btn-primary" style="width: 100%;">
                                    üöÄ Continue Build
                                </button>
                            </div>
                            <div id="deploy-logs" class="log-output" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; background: var(--bg-input); padding: 12px; border-radius: 8px; white-space: pre-wrap; word-break: break-word;">
                            </div>
                        </div>
                        <div id="deploy-result" style="display: none;">
                        </div>
                        <div id="deploy-empty" class="empty-state">
                            <p>No deployment in progress</p>
                            <p style="font-size: 0.8rem; color: var(--text-muted);">Fill in the form and click Deploy to start</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Architecture Tab -->
            <div id="tab-architecture" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üèóÔ∏è Architecture View</span>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="arch-project-filter" style="width: 140px; padding: 6px 10px;" onchange="loadArchitecture()">
                                <option value="">All Projects</option>
                            </select>
                            <select id="arch-env-filter" style="width: 120px; padding: 6px 10px;" onchange="loadArchitecture()">
                                <option value="">All Envs</option>
                                <option value="prod">prod</option>
                                <option value="staging">staging</option>
                                <option value="dev">dev</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="loadArchitecture()">üîÑ Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div style="display: flex; gap: 20px; margin-bottom: 16px; padding: 12px; background: var(--bg-input); border-radius: 8px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 4px;"></div>
                            <span style="font-size: 0.85rem;">Service</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 20px; height: 20px; background: #8b5cf6; border-radius: 4px;"></div>
                            <span style="font-size: 0.85rem;">Stateful (DB/Cache)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="width: 20px; height: 20px; background: #10b981; border-radius: 4px;"></div>
                            <span style="font-size: 0.85rem;">Proxy</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <svg width="40" height="20"><line x1="0" y1="10" x2="40" y2="10" stroke="#6b7280" stroke-width="2" stroke-dasharray="4"/></svg>
                            <span style="font-size: 0.85rem;">Depends On</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; margin-left: auto;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Drag nodes to rearrange</span>
                        </div>
                    </div>
                    
                    <!-- Architecture Diagram -->
                    <div id="architecture-container" style="position: relative; min-height: 400px; background: var(--bg-input); border-radius: 8px; overflow: hidden;">
                        <svg id="architecture-svg" width="100%" height="500" style="display: block;">
                            <!-- Edges will be rendered here -->
                            <g id="arch-edges"></g>
                            <!-- Nodes will be rendered here -->
                            <g id="arch-nodes"></g>
                        </svg>
                        <div id="arch-empty" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 8px;">üèóÔ∏è</div>
                            <p>No services deployed yet</p>
                            <p style="font-size: 0.85rem;">Deploy services to see your architecture</p>
                        </div>
                    </div>
                </div>
                
                <!-- Details Panel -->
                <div class="grid grid-2" style="margin-top: 16px;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üìä Services</span>
                        </div>
                        <div id="arch-services-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="empty-state" style="padding: 20px; text-align: center;">
                                <p style="color: var(--text-muted);">Click "Refresh" to load services</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üñ•Ô∏è Servers</span>
                        </div>
                        <div id="arch-servers-list" style="max-height: 300px; overflow-y: auto;">
                            <div class="empty-state" style="padding: 20px; text-align: center;">
                                <p style="color: var(--text-muted);">Server status will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Infrastructure Section -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">‚öôÔ∏è Infrastructure</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Nginx sidecar, agents, proxies</span>
                    </div>
                    <div id="arch-infrastructure" style="overflow-x: auto;">
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <p style="color: var(--text-muted);">Infrastructure status will appear here</p>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Matrix -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">üîó Connection Matrix</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Who talks to whom</span>
                    </div>
                    <div id="arch-matrix" style="overflow-x: auto;">
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <p style="color: var(--text-muted);">Connection data will appear here</p>
                        </div>
                    </div>
                </div>
                
                <!-- Traffic Flow Visualization -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">üö¶ Traffic Flow</span>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Request path from client to container</span>
                    </div>
                    <div id="arch-traffic-flow" style="padding: 16px;">
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <p style="color: var(--text-muted);">Traffic flow will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="tab-logs" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìã Container Logs</span>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <select id="logs-project-filter" style="width: 140px; padding: 6px 10px;" onchange="onLogsProjectChange()">
                                <option value="">All Projects</option>
                            </select>
                            <select id="logs-env-filter" style="width: 120px; padding: 6px 10px;" onchange="onLogsEnvChange()">
                                <option value="">All Envs</option>
                                <option value="prod">prod</option>
                                <option value="staging">staging</option>
                                <option value="dev">dev</option>
                            </select>
                            <select id="logs-server-filter" style="width: 180px; padding: 6px 10px;" onchange="onLogsServerChange()">
                                <option value="">All Servers</option>
                            </select>
                            <select id="logs-container-filter" style="width: 180px; padding: 6px 10px;">
                                <option value="">Select Container</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="loadContainerLogs()">üìã View Logs</button>
                            <button class="btn btn-ghost btn-sm" onclick="refreshLogsFilters()">‚Üª Refresh</button>
                        </div>
                    </div>
                    
                    <div id="logs-container-list" style="margin-bottom: 16px;">
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <p style="color: var(--text-muted);">Select filters above and click "View Logs" to see container logs.</p>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">
                                Tip: Filter by project/environment to narrow down servers.
                            </p>
                        </div>
                    </div>
                    
                    <div id="logs-output" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span id="logs-title" style="font-weight: 600; color: var(--text-muted);"></span>
                            <div>
                                <button class="btn btn-ghost btn-sm" onclick="loadContainerLogs()">‚Üª Refresh</button>
                                <button class="btn btn-ghost btn-sm" onclick="document.getElementById('logs-output').style.display='none'">‚úï Close</button>
                            </div>
                        </div>
                        <pre id="logs-content" style="background: var(--bg-input); padding: 16px; border-radius: 8px; 
                                    max-height: 500px; overflow: auto; font-size: 12px; white-space: pre-wrap; word-break: break-word;"></pre>
                    </div>
                </div>
            </div>
            
            <!-- Snapshots Tab -->
            <div id="tab-snapshots" class="hidden">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üì∏ Your Snapshots</span>
                            <button class="btn btn-success btn-sm" onclick="showBuildSnapshotModal()">+ Custom</button>
                        </div>
                        <div id="snapshot-list">
                            <div class="empty-state"><p>Loading...</p></div>
                        </div>
                        <div id="snapshot-details" style="display: none;"></div>
                        <button class="btn btn-ghost btn-sm" onclick="loadSnapshots()" style="margin-top: 12px;">‚Üª Refresh</button>
                    </div>
                    
                    <div>
                        <!-- Base Snapshot Status -->
                        <div id="base-snapshot-card" class="card">
                            <div class="card-header">
                                <span class="card-title">üèóÔ∏è Base Snapshot</span>
                            </div>
                            <div id="base-snapshot-status">
                                <p style="color: var(--text-muted);">Checking...</p>
                            </div>
                        </div>
                        
                        <!-- App Registry -->
                        <div class="card" style="margin-top: 16px;">
                            <div class="card-header">
                                <span class="card-title">üì¶ App Registry (DO)</span>
                            </div>
                            <div id="registry-status">
                                <p style="color: var(--text-muted);">Checking...</p>
                            </div>
                        </div>
                        
                        <!-- Streaming Log Output -->
                        <div id="snapshot-log-card" class="card hidden" style="margin-top: 16px;">
                            <div class="card-header">
                                <span class="card-title">üìã Progress</span>
                                <button class="btn btn-ghost btn-sm" onclick="hideSnapshotLog()">‚úï</button>
                            </div>
                            <div class="progress-bar">
                                <div id="snapshot-progress" class="progress-fill" style="width: 0%;"></div>
                            </div>
                            <div id="snapshot-log" class="log-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Services Tab - Deploy stateful services -->
            <div id="tab-services" class="hidden">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üóÑÔ∏è Deploy Database/Cache</span>
                        </div>
                        
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.875rem;">
                            Deploy stateful services with automatic configuration, persistence, and service mesh.
                        </p>
                        
                        <form id="stateful-service-form" onsubmit="deployStatefulService(event)">
                            <div class="form-group">
                                <label>Service Type</label>
                                <select id="stateful-service-type" required>
                                    <option value="">Select service...</option>
                                    <option value="postgres">üêò PostgreSQL</option>
                                    <option value="redis">‚ö° Redis</option>
                                    <option value="mysql">üê¨ MySQL</option>
                                    <option value="mongo">üçÉ MongoDB</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Project</label>
                                <input type="text" id="stateful-project" placeholder="myapp" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Environment</label>
                                <select id="stateful-environment">
                                    <option value="prod">Production</option>
                                    <option value="staging">Staging</option>
                                    <option value="dev">Development</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Target Server</label>
                                <select id="stateful-server" required>
                                    <option value="">Select server...</option>
                                </select>
                                <small style="color: var(--text-muted);">Servers from Infrastructure tab</small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                üöÄ Deploy Service
                            </button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">üìã Deployment Result</span>
                        </div>
                        
                        <div id="stateful-result-empty" style="padding: 40px; text-align: center; color: var(--text-muted);">
                            <div style="font-size: 2rem; margin-bottom: 8px;">üóÑÔ∏è</div>
                            <div>Deploy a service to see connection details</div>
                        </div>
                        
                        <div id="stateful-result" class="hidden">
                            <div id="stateful-result-content"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">‚ÑπÔ∏è How It Works</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="padding: 12px; background: var(--bg-card); border-radius: 8px;">
                            <strong>üîê Auto Credentials</strong>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                Deterministic passwords generated from project/env. Same inputs = same password.
                            </p>
                        </div>
                        <div style="padding: 12px; background: var(--bg-card); border-radius: 8px;">
                            <strong>üíæ Persistent Storage</strong>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                Data volumes mounted at /data. Survives container restarts and redeploys.
                            </p>
                        </div>
                        <div style="padding: 12px; background: var(--bg-card); border-radius: 8px;">
                            <strong>üîÄ Service Mesh</strong>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                Nginx proxy on internal ports. Apps connect to localhost:PORT.
                            </p>
                        </div>
                        <div style="padding: 12px; background: var(--bg-card); border-radius: 8px;">
                            <strong>üîß Auto-Inject</strong>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                Enable "Auto-inject" in Deploy tab to get DATABASE_URL automatically.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="tab-settings" class="hidden">
                <div class="card" style="max-width: 600px;">
                    <div class="card-header">
                        <span class="card-title">‚öôÔ∏è DigitalOcean Credentials</span>
                    </div>
                    
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.875rem;">
                        Get your token from 
                        <a href="https://cloud.digitalocean.com/account/api/tokens" target="_blank" style="color: var(--primary);">
                            DO Control Panel
                        </a>.
                    </p>
                    
                    <div style="background: var(--bg-input); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">üîí Browser Storage</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Token stored in browser cookie. Passed with each API request. Never stored on server.
                        </div>
                    </div>
                    
                    <form onsubmit="saveDOToken(event)">
                        <div class="form-group">
                            <label>DigitalOcean API Token</label>
                            <input type="password" id="do-token" placeholder="dop_v1_..." autocomplete="off">
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary">Save Token</button>
                            <button type="button" class="btn btn-ghost" onclick="testDOToken()">Test</button>
                            <button type="button" class="btn btn-ghost" onclick="showAgentKey()">üîë Show Agent Key</button>
                            <button type="button" class="btn btn-danger" onclick="deleteDOToken()">Clear</button>
                        </div>
                    </form>
                    
                    <div id="agent-key-display" style="margin-top: 16px; display: none;">
                        <div style="background: var(--bg-input); border-radius: 8px; padding: 16px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">üîë Node Agent API Key</div>
                            <code id="agent-key-value" style="display: block; word-break: break-all; font-size: 0.9rem; padding: 8px; background: var(--bg-secondary); border-radius: 4px;"></code>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">Use this for debugging agent connectivity</p>
                        </div>
                    </div>
                    
                    <div id="token-status" style="margin-top: 16px;"></div>
                </div>
                
                <!-- Cloudflare Settings -->
                <div class="card" style="max-width: 600px; margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">‚òÅÔ∏è Cloudflare (DNS & SSL)</span>
                    </div>
                    
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.875rem;">
                        Get your token from 
                        <a href="https://dash.cloudflare.com/profile/api-tokens" target="_blank" style="color: var(--primary);">
                            Cloudflare Dashboard
                        </a>. Needs "Edit DNS" and "Edit Load Balancers" permissions.
                    </p>
                    
                    <form onsubmit="saveCFToken(event)">
                        <div class="form-group">
                            <label>Cloudflare API Token</label>
                            <input type="password" id="cf-token" placeholder="..." autocomplete="off">
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="submit" class="btn btn-primary">Save Token</button>
                            <button type="button" class="btn btn-ghost" onclick="testCFToken()">Test</button>
                            <button type="button" class="btn btn-danger" onclick="deleteCFToken()">Clear</button>
                        </div>
                    </form>
                    
                    <div id="cf-token-status" style="margin-top: 16px;"></div>
                </div>
                
                <!-- Domain Setup -->
                <div class="card" style="max-width: 600px; margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">üåê Domain Setup</span>
                    </div>
                    
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.875rem;">
                        Point a domain to your server. With "Proxied" enabled, HTTPS works automatically.
                    </p>
                    
                    <form onsubmit="setupDomain(event)">
                        <div class="form-group">
                            <label>Domain</label>
                            <input type="text" id="domain-name" placeholder="api.example.com" required>
                        </div>
                        <div class="form-group">
                            <label>Server IP</label>
                            <input type="text" id="domain-ip" placeholder="1.2.3.4" required>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="domain-proxied" checked style="width: auto;">
                                <span>Proxied (Cloudflare handles SSL)</span>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Setup Domain</button>
                    </form>
                    
                    <div id="domain-result" style="margin-top: 16px;"></div>
                </div>
                
                <!-- DNS Round-Robin (Cloudflare multi-A) -->
                <div class="card" style="max-width: 600px; margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">üåê DNS Round-Robin (Cloudflare)</span>
                    </div>
                    
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.875rem;">
                        Simple load distribution via multiple A records. Cloudflare rotates between IPs at DNS level.
                        <strong>FREE</strong>, but no health checks - all IPs receive traffic.
                    </p>
                    
                    <form onsubmit="setupLoadBalancer(event)">
                        <div class="form-group">
                            <label>Domain</label>
                            <input type="text" id="lb-domain" placeholder="api.example.com" required>
                        </div>
                        <div class="form-group">
                            <label>Server IPs (comma-separated)</label>
                            <input type="text" id="lb-ips" placeholder="1.2.3.4, 5.6.7.8" required>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="lb-proxied" checked style="width: auto;">
                                <span>Proxied (SSL + CDN)</span>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Setup DNS Round-Robin</button>
                    </form>
                    
                    <div id="lb-result" style="margin-top: 16px;"></div>
                    
                    <!-- Add/Remove Server -->
                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="font-weight: 500; margin-bottom: 12px;">Manage Servers</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="text" id="lb-manage-domain" placeholder="Domain">
                            <input type="text" id="lb-manage-ip" placeholder="Server IP">
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" class="btn btn-ghost" onclick="addServerToLB()">‚ûï Add</button>
                            <button type="button" class="btn btn-ghost" onclick="removeServerFromLB()">‚ûñ Remove</button>
                            <button type="button" class="btn btn-ghost" onclick="listLBServers()">üìã List</button>
                        </div>
                        <div id="lb-manage-result" style="margin-top: 12px;"></div>
                    </div>
                </div>
                
                <!-- Load Balancing Info -->
                <div class="card" style="max-width: 700px; margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">‚öñÔ∏è Load Balancing</span>
                    </div>
                    
                    <!-- Sidecar explanation -->
                    <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3); margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 1.2rem;">‚úÖ</span>
                            <span style="font-weight: 600; color: var(--success);">Internal Load Balancing: Automatic</span>
                        </div>
                        <p style="margin: 0; font-size: 0.875rem; color: var(--text-muted);">
                            The <strong>nginx sidecar</strong> is automatically deployed on each server and handles:
                        </p>
                        <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-muted);">
                            <li><strong>Service discovery:</strong> Apps connect to <code>localhost:PORT</code> for databases/caches</li>
                            <li><strong>Internal routing:</strong> Service-to-service communication within the same server</li>
                            <li><strong>Multi-server:</strong> When a service runs on multiple servers, sidecar load-balances between them</li>
                        </ul>
                        <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">
                            See the <a href="#" onclick="showTab('architecture'); return false;" style="color: var(--primary);">Architecture tab</a> for nginx sidecar status.
                        </p>
                    </div>
                    
                    <!-- External LB options -->
                    <div style="font-weight: 600; margin-bottom: 12px;">üåê External Load Balancing (Internet ‚Üí Your App)</div>
                    
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.875rem;">
                        For exposing your app to the internet with high availability:
                    </p>
                    
                    <div style="display: grid; gap: 12px; margin-bottom: 16px;">
                        <!-- Option 1: Cloudflare -->
                        <div style="padding: 12px; background: var(--bg-input); border-radius: 8px; border-left: 3px solid var(--primary);">
                            <div style="font-weight: 500; margin-bottom: 4px;">1. Cloudflare DNS (Recommended)</div>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                                Add multiple A records for your domain pointing to each server IP. Cloudflare handles SSL, DDoS protection, and round-robin across servers.
                            </p>
                        </div>
                        
                        <!-- Option 2: DO LB -->
                        <div style="padding: 12px; background: var(--bg-input); border-radius: 8px; border-left: 3px solid #6b7280;">
                            <div style="font-weight: 500; margin-bottom: 4px;">2. DigitalOcean Load Balancer ($12/mo)</div>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                                Managed LB with health checks. Create via DO console and point to your droplet IPs.
                            </p>
                        </div>
                        
                        <!-- Option 3: Custom nginx LB -->
                        <div style="padding: 12px; background: var(--bg-input); border-radius: 8px; border-left: 3px solid #6b7280;">
                            <div style="font-weight: 500; margin-bottom: 4px;">3. Dedicated Nginx LB Server (Advanced)</div>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                                Run nginx on a separate server as an entry point. Use if you need custom routing rules or can't use Cloudflare/DO LB.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Collapsible advanced Nginx LB setup -->
                    <details style="margin-top: 16px;">
                        <summary style="cursor: pointer; font-weight: 500; padding: 8px; background: var(--bg-input); border-radius: 6px;">
                            üîß Advanced: Custom Nginx Entry Point Setup
                        </summary>
                        
                        <div style="padding: 16px; border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px;">
                            <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.85rem;">
                                <strong>‚ö†Ô∏è Note:</strong> Only use this if you need a dedicated entry-point server separate from your app servers.
                                The automatic nginx sidecar already handles load balancing between app instances.
                            </p>
                            
                            <form onsubmit="setupNginxLB(event)">
                                <div class="form-group">
                                    <label>LB Name</label>
                                    <input type="text" id="nginx-lb-name" placeholder="myapp_prod_api" required>
                                </div>
                                <div class="form-group">
                                    <label>Entry Point Server IP (dedicated LB server)</label>
                                    <input type="text" id="nginx-lb-server" placeholder="1.2.3.4" required>
                                    <small style="color: var(--text-muted);">This should be a different server from your app servers</small>
                                </div>
                                <div class="form-group">
                                    <label>Backend App Servers (IP:port, comma-separated)</label>
                                    <input type="text" id="nginx-lb-backends" placeholder="10.0.0.1:8000, 10.0.0.2:8000" required>
                                </div>
                                <div class="form-group">
                                    <label>Domain (optional)</label>
                                    <input type="text" id="nginx-lb-domain" placeholder="api.example.com">
                                </div>
                                <div class="form-group">
                                    <label>Load Balancing Method</label>
                                    <select id="nginx-lb-method">
                                        <option value="least_conn">Least Connections (recommended)</option>
                                        <option value="round_robin">Round Robin</option>
                                        <option value="ip_hash">IP Hash (sticky sessions)</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Setup Entry Point</button>
                            </form>
                            
                            <div id="nginx-lb-result" style="margin-top: 16px;"></div>
                            
                            <!-- Manage existing -->
                            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border);">
                                <div style="font-weight: 500; margin-bottom: 12px;">Manage Existing Entry Point</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <input type="text" id="nginx-lb-manage-name" placeholder="LB name">
                                    <input type="text" id="nginx-lb-manage-server" placeholder="Entry point server IP">
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button type="button" class="btn btn-ghost" onclick="updateNginxLB()">üîÑ Update Backends</button>
                                    <button type="button" class="btn btn-danger" onclick="deleteNginxLB()">üóëÔ∏è Delete</button>
                                </div>
                                <div id="nginx-lb-manage-result" style="margin-top: 12px;"></div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // Cookie Helpers
        // =============================================================================
        
        function setCookie(name, value, days = 7) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Strict`;
        }
        
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            return match ? decodeURIComponent(match[2]) : null;
        }
        
        function deleteCookie(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Strict`;
        }
        
        // =============================================================================
        // State
        // =============================================================================
        
        const EXPECTED_AGENT_VERSION = '1.8.3';  // Keep in sync with agent_code.py AGENT_VERSION
        
        const state = {
            token: getCookie('jwt_token'),
            user: null,
            servers: [],
            snapshots: [],
            vpcs: {},
        };
        
        const API_BASE = window.location.origin + '/api/v1';
        
        // =============================================================================
        // API
        // =============================================================================
        
        function getLocalDoToken() {
            return getCookie('do_token_local');
        }
        
        async function api(method, path, data = null, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.token) {
                headers['Authorization'] = `Bearer ${state.token}`;
            }
            
            // Add DO token as query param for infra endpoints
            let url = API_BASE + path;
            if (path.startsWith('/infra') && !options.skipDoToken) {
                const doToken = getLocalDoToken();
                if (doToken) {
                    const sep = url.includes('?') ? '&' : '?';
                    url += `${sep}do_token=${encodeURIComponent(doToken)}`;
                }
            }
            
            const opts = { method, headers };
            if (data) opts.body = JSON.stringify(data);
            
            const res = await fetch(url, opts);
            
            if (res.status === 401) {
                // Try to get actual error message from response
                let errorMsg = 'Authentication failed';
                try {
                    const errBody = await res.json();
                    errorMsg = errBody.detail || errBody.error || errBody.message || errorMsg;
                } catch {}
                
                // Only auto-logout if we had a token (session-based request failed)
                // Don't logout for login attempts (no token yet)
                if (state.token) {
                    logout();
                    errorMsg = 'Session expired - please login again';
                }
                
                throw new Error(errorMsg);
            }
            
            if (!res.ok) {
                const err = await res.json().catch(() => ({ detail: 'Request failed' }));
                throw new Error(err.detail || err.error || err.message || 'Request failed');
            }
            
            if (res.status === 204) return null;
            
            const result = await res.json();
            
            // Unwrap proxy response format: { success: true, data: {...} }
            if (result && result.success === true && result.data !== undefined) {
                return result.data;
            }
            
            return result;
        }
        
        // =============================================================================
        // Auth
        // =============================================================================
        
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-card .tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'signup' && i === 1));
            });
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', tab !== 'signup');
            document.getElementById('auth-error').classList.add('hidden');
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const res = await api('POST', '/auth/login', { username: email, password });
                state.token = res.access_token;
                setCookie('jwt_token', state.token, 7);
                await initApp();
            } catch (err) {
                document.getElementById('auth-error').textContent = err.message;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            
            if (password !== confirm) {
                document.getElementById('auth-error').textContent = 'Passwords do not match';
                document.getElementById('auth-error').classList.remove('hidden');
                return;
            }
            
            try {
                await api('POST', '/auth/register', { username: email, email, password });
                const res = await api('POST', '/auth/login', { username: email, password });
                state.token = res.access_token;
                setCookie('jwt_token', state.token, 7);
                await initApp();
            } catch (err) {
                document.getElementById('auth-error').textContent = err.message;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        }
        
        function logout() {
            state.token = null;
            state.user = null;
            deleteCookie('jwt_token');
            deleteCookie('do_token_local');  // Clear DO token on logout
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
        
        // =============================================================================
        // Tabs
        // =============================================================================
        
        function showTab(tab) {
            ['infra', 'deploy', 'architecture', 'logs', 'snapshots', 'services', 'settings'].forEach((t, i) => {
                document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab);
                document.querySelectorAll('.tabs .tab')[i].classList.toggle('active', t === tab);
            });
            if (tab === 'infra') loadServers();  // Reload with tag filter
            if (tab === 'snapshots') loadSnapshots();
            if (tab === 'deploy') {
                loadSnapshotsForDeploy();
                loadServersForDeploy();  // Reload servers without project filter
            }
            if (tab === 'services') loadServersForStateful();
            if (tab === 'logs') refreshLogsFilters();
            if (tab === 'architecture') loadArchitecture();
        }
        
        // =============================================================================
        // Architecture Tab Functions
        // =============================================================================
        
        let archState = {
            nodes: [],
            edges: [],
            servers: [],
            dragging: null,
            nodePositions: {},  // Cache positions for drag & drop
            infrastructure: [],  // nginx, agents, etc.
        };
        
        async function loadArchitecture() {
            const project = document.getElementById('arch-project-filter').value;
            const env = document.getElementById('arch-env-filter').value;
            
            try {
                const result = await api('POST', '/infra/architecture', {
                    project: project || null,
                    environment: env || null,
                });
                
                archState.nodes = result.nodes || [];
                archState.edges = result.edges || [];
                archState.servers = result.servers || [];
                archState.infrastructure = result.infrastructure || [];
                
                renderArchitecture();
                renderServicesList();
                renderServersList();
                renderInfrastructure();
                renderConnectionMatrix();
                renderTrafficFlow();
                
                // Also update filters
                loadArchitectureProjects();
                
            } catch (e) {
                console.error('Failed to load architecture:', e);
                toast('Failed to load architecture: ' + e.message, 'error');
            }
        }
        
        async function loadArchitectureProjects() {
            try {
                const result = await api('GET', '/infra/architecture/projects');
                const projectSelect = document.getElementById('arch-project-filter');
                const currentProject = projectSelect.value;
                projectSelect.innerHTML = '<option value="">All Projects</option>' + 
                    (result.projects || []).map(p => `<option value="${p}"${p === currentProject ? ' selected' : ''}>${p}</option>`).join('');
            } catch (e) {
                console.error('Failed to load architecture projects:', e);
            }
        }
        
        function renderArchitecture() {
            const svg = document.getElementById('architecture-svg');
            const nodesG = document.getElementById('arch-nodes');
            const edgesG = document.getElementById('arch-edges');
            const emptyDiv = document.getElementById('arch-empty');
            
            nodesG.innerHTML = '';
            edgesG.innerHTML = '';
            
            if (archState.nodes.length === 0) {
                emptyDiv.style.display = 'block';
                return;
            }
            emptyDiv.style.display = 'none';
            
            const svgRect = svg.getBoundingClientRect();
            const width = svgRect.width || 800;
            const height = 500;
            
            // Layout nodes in a force-directed-like pattern
            const nodeRadius = 50;
            const padding = 80;
            
            // Group by project for better layout
            const projects = {};
            archState.nodes.forEach(node => {
                const key = `${node.project}_${node.env}`;
                if (!projects[key]) projects[key] = [];
                projects[key].push(node);
            });
            
            // Calculate positions
            const projectKeys = Object.keys(projects);
            const projectWidth = (width - padding * 2) / Math.max(projectKeys.length, 1);
            
            projectKeys.forEach((key, pIdx) => {
                const nodes = projects[key];
                const baseX = padding + projectWidth * pIdx + projectWidth / 2;
                
                // Separate stateful (bottom) from services (top)
                const stateful = nodes.filter(n => n.type === 'stateful');
                const services = nodes.filter(n => n.type !== 'stateful');
                
                services.forEach((node, idx) => {
                    const x = archState.nodePositions[node.id]?.x || baseX + (idx - services.length/2) * 120;
                    const y = archState.nodePositions[node.id]?.y || 120 + (idx % 2) * 60;
                    archState.nodePositions[node.id] = { x, y };
                });
                
                stateful.forEach((node, idx) => {
                    const x = archState.nodePositions[node.id]?.x || baseX + (idx - stateful.length/2) * 120;
                    const y = archState.nodePositions[node.id]?.y || height - 120;
                    archState.nodePositions[node.id] = { x, y };
                });
            });
            
            // Draw edges first (so they're behind nodes)
            archState.edges.forEach(edge => {
                const from = archState.nodePositions[edge.from];
                const to = archState.nodePositions[edge.to];
                if (!from || !to) return;
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', from.x);
                line.setAttribute('y1', from.y);
                line.setAttribute('x2', to.x);
                line.setAttribute('y2', to.y);
                line.setAttribute('stroke', '#6b7280');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('stroke-dasharray', '6,4');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                edgesG.appendChild(line);
                
                // Label
                const midX = (from.x + to.x) / 2;
                const midY = (from.y + to.y) / 2;
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', midX);
                label.setAttribute('y', midY - 8);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', '#9ca3af');
                label.setAttribute('font-size', '11');
                label.textContent = edge.label || '';
                edgesG.appendChild(label);
            });
            
            // Draw nodes
            archState.nodes.forEach(node => {
                const pos = archState.nodePositions[node.id];
                if (!pos) return;
                
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('transform', `translate(${pos.x}, ${pos.y})`);
                g.setAttribute('cursor', 'move');
                g.setAttribute('data-node-id', node.id);
                
                // Background
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', -nodeRadius);
                rect.setAttribute('y', -30);
                rect.setAttribute('width', nodeRadius * 2);
                rect.setAttribute('height', 60);
                rect.setAttribute('rx', '8');
                rect.setAttribute('fill', getNodeColor(node.type));
                rect.setAttribute('stroke', getNodeBorderColor(node.type));
                rect.setAttribute('stroke-width', '2');
                g.appendChild(rect);
                
                // Icon
                const icon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                icon.setAttribute('x', '0');
                icon.setAttribute('y', '-5');
                icon.setAttribute('text-anchor', 'middle');
                icon.setAttribute('font-size', '18');
                icon.textContent = getNodeIcon(node);
                g.appendChild(icon);
                
                // Service name
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', '0');
                text.setAttribute('y', '16');
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-size', '12');
                text.setAttribute('font-weight', '600');
                text.textContent = node.service.length > 10 ? node.service.substring(0, 9) + '‚Ä¶' : node.service;
                g.appendChild(text);
                
                // Server count badge
                if (node.servers && node.servers.length > 1) {
                    const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    badge.setAttribute('cx', nodeRadius - 10);
                    badge.setAttribute('cy', -20);
                    badge.setAttribute('r', '12');
                    badge.setAttribute('fill', '#10b981');
                    g.appendChild(badge);
                    
                    const badgeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    badgeText.setAttribute('x', nodeRadius - 10);
                    badgeText.setAttribute('y', -16);
                    badgeText.setAttribute('text-anchor', 'middle');
                    badgeText.setAttribute('fill', 'white');
                    badgeText.setAttribute('font-size', '10');
                    badgeText.setAttribute('font-weight', 'bold');
                    badgeText.textContent = node.servers.length;
                    g.appendChild(badgeText);
                }
                
                // Drag handlers
                g.addEventListener('mousedown', startDrag);
                g.addEventListener('click', () => showNodeDetails(node));
                
                nodesG.appendChild(g);
            });
            
            // Add arrow marker definition if not exists
            let defs = svg.querySelector('defs');
            if (!defs) {
                defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                svg.insertBefore(defs, svg.firstChild);
            }
            if (!defs.querySelector('#arrowhead')) {
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', 'arrowhead');
                marker.setAttribute('markerWidth', '10');
                marker.setAttribute('markerHeight', '7');
                marker.setAttribute('refX', '9');
                marker.setAttribute('refY', '3.5');
                marker.setAttribute('orient', 'auto');
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
                polygon.setAttribute('fill', '#6b7280');
                marker.appendChild(polygon);
                defs.appendChild(marker);
            }
        }
        
        function getNodeColor(type) {
            switch(type) {
                case 'stateful': return '#8b5cf6';
                case 'proxy': return '#10b981';
                default: return '#3b82f6';
            }
        }
        
        function getNodeBorderColor(type) {
            switch(type) {
                case 'stateful': return '#7c3aed';
                case 'proxy': return '#059669';
                default: return '#2563eb';
            }
        }
        
        function getNodeIcon(node) {
            const service = node.service.toLowerCase();
            if (service.includes('postgres')) return 'üêò';
            if (service.includes('mysql') || service.includes('mariadb')) return 'üê¨';
            if (service.includes('redis')) return '‚ö°';
            if (service.includes('mongo')) return 'üçÉ';
            if (service.includes('nginx')) return 'üîÄ';
            if (service.includes('api')) return 'üîå';
            if (service.includes('web') || service.includes('frontend')) return 'üåê';
            if (service.includes('worker')) return '‚öôÔ∏è';
            return 'üì¶';
        }
        
        let dragState = { node: null, startX: 0, startY: 0 };
        
        function startDrag(e) {
            const g = e.target.closest('g[data-node-id]');
            if (!g) return;
            
            e.preventDefault();
            dragState.node = g.getAttribute('data-node-id');
            dragState.startX = e.clientX;
            dragState.startY = e.clientY;
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function onDrag(e) {
            if (!dragState.node) return;
            
            const dx = e.clientX - dragState.startX;
            const dy = e.clientY - dragState.startY;
            
            const pos = archState.nodePositions[dragState.node];
            if (pos) {
                pos.x += dx;
                pos.y += dy;
            }
            
            dragState.startX = e.clientX;
            dragState.startY = e.clientY;
            
            renderArchitecture();
        }
        
        function stopDrag() {
            dragState.node = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        function showNodeDetails(node) {
            toast(`${node.service} (${node.project}/${node.env})\n` +
                  `Servers: ${node.servers.join(', ')}\n` +
                  `Ports: ${node.ports.join(', ') || 'N/A'}`, 'info');
        }
        
        function renderServicesList() {
            const list = document.getElementById('arch-services-list');
            if (archState.nodes.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><p style="color: var(--text-muted);">No services found</p></div>';
                return;
            }
            
            list.innerHTML = archState.nodes.map(node => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-size: 1.5rem;">${getNodeIcon(node)}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${node.service}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${node.project} / ${node.env}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.85rem;">${node.servers.length} server${node.servers.length > 1 ? 's' : ''}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${node.ports.join(', ') || '-'}</div>
                    </div>
                    <span class="badge badge-${node.type === 'stateful' ? 'warning' : 'info'}" style="font-size: 0.7rem;">
                        ${node.type}
                    </span>
                </div>
            `).join('');
        }
        
        function renderServersList() {
            const list = document.getElementById('arch-servers-list');
            if (archState.servers.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><p style="color: var(--text-muted);">No servers found</p></div>';
                return;
            }
            
            list.innerHTML = archState.servers.map(server => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border);">
                    <div style="font-size: 1.2rem;">${server.status === 'online' ? 'üü¢' : 'üî¥'}</div>
                    <div style="flex: 1;">
                        <div style="font-family: monospace; font-size: 0.9rem;">${server.ip}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            ${server.containers} container${server.containers !== 1 ? 's' : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <span class="badge badge-${server.nginx_status === 'running' ? 'success' : 'warning'}" style="font-size: 0.7rem;">
                            ${server.nginx_status === 'running' ? 'üîÄ nginx' : '‚ö†Ô∏è no nginx'}
                        </span>
                        <span class="badge badge-info" style="font-size: 0.7rem;">
                            ü§ñ v${server.agent_version || '?'}
                        </span>
                    </div>
                    ${server.error ? `<span style="color: var(--error); font-size: 0.8rem;">${server.error}</span>` : ''}
                </div>
            `).join('');
        }
        
        function renderInfrastructure() {
            const container = document.getElementById('arch-infrastructure');
            
            if (archState.infrastructure.length === 0 && archState.servers.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><p style="color: var(--text-muted);">No infrastructure found</p></div>';
                return;
            }
            
            // Count nginx instances
            const nginxCount = archState.servers.filter(s => s.nginx_status === 'running').length;
            const totalServers = archState.servers.length;
            const missingNginx = archState.servers.filter(s => s.nginx_status !== 'running').map(s => s.ip);
            
            // Summary cards
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 16px;">';
            
            // Nginx Sidecar Status
            const nginxOk = nginxCount === totalServers;
            html += `
                <div style="padding: 16px; background: ${nginxOk ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 8px; border: 1px solid ${nginxOk ? 'rgba(16, 185, 129, 0.3)' : 'rgba(245, 158, 11, 0.3)'};">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.5rem;">üîÄ</span>
                        <span style="font-weight: 600;">Nginx Sidecar</span>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: ${nginxOk ? 'var(--success)' : 'var(--warning)'};">
                        ${nginxCount}/${totalServers}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">servers with nginx</div>
                    ${!nginxOk ? `
                        <button onclick="fixMissingNginx()" class="btn btn-warning btn-sm" style="margin-top: 12px; width: 100%;">
                            üîß Fix ${missingNginx.length} server${missingNginx.length > 1 ? 's' : ''}
                        </button>
                    ` : `
                        <div style="margin-top: 8px; font-size: 0.75rem; color: var(--success);">
                            ‚úÖ All servers OK
                        </div>
                    `}
                </div>
            `;
            
            // Agent Status  
            const agentVersions = {};
            archState.servers.forEach(s => {
                const v = s.agent_version || 'unknown';
                agentVersions[v] = (agentVersions[v] || 0) + 1;
            });
            const versionList = Object.entries(agentVersions).map(([v, c]) => `v${v}: ${c}`).join(', ');
            
            html += `
                <div style="padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.5rem;">ü§ñ</span>
                        <span style="font-weight: 600;">Node Agents</span>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                        ${totalServers}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">agents running</div>
                    <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-muted);">
                        ${versionList}
                    </div>
                </div>
            `;
            
            // Service Mesh info
            const servicesOnMultipleServers = archState.nodes.filter(n => n.servers && n.servers.length > 1).length;
            html += `
                <div style="padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.5rem;">üåê</span>
                        <span style="font-weight: 600;">Load Balanced</span>
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">
                        ${servicesOnMultipleServers}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">services on 2+ servers</div>
                    <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-muted);">
                        Auto-balanced via nginx sidecar
                    </div>
                </div>
            `;
            
            html += '</div>';
            
            // Warning banner if nginx missing
            if (!nginxOk) {
                html += `
                    <div style="margin: 0 16px 16px; padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--warning);">Missing Nginx Sidecar</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Servers without nginx: ${missingNginx.join(', ')}
                                </div>
                            </div>
                            <button onclick="fixMissingNginx()" class="btn btn-warning btn-sm">
                                üîß Fix All
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Individual infrastructure containers
            if (archState.infrastructure.length > 0) {
                html += '<div style="border-top: 1px solid var(--border); padding: 16px;">';
                html += '<div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">Infrastructure Containers:</div>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                
                archState.infrastructure.forEach(infra => {
                    const icon = infra.type === 'nginx' ? 'üîÄ' : infra.type === 'agent' ? 'ü§ñ' : 'üì¶';
                    html += `
                        <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-input); border-radius: 6px; font-size: 0.8rem;">
                            ${icon}
                            <span style="font-weight: 500;">${infra.name}</span>
                            <span style="color: var(--text-muted);">@</span>
                            <span style="font-family: monospace; font-size: 0.75rem;">${infra.server_ip}</span>
                            ${infra.ports.length > 0 ? `<span style="color: var(--text-muted); font-size: 0.7rem;">${infra.ports[0]}</span>` : ''}
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            container.innerHTML = html;
        }
        
        function renderConnectionMatrix() {
            const container = document.getElementById('arch-matrix');
            
            if (archState.nodes.length === 0 || archState.edges.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><p style="color: var(--text-muted);">No connections detected yet</p></div>';
                return;
            }
            
            // Build matrix data
            const services = archState.nodes.map(n => n.id);
            const matrix = {};
            services.forEach(s => { matrix[s] = {}; services.forEach(t => { matrix[s][t] = false; }); });
            archState.edges.forEach(e => { matrix[e.from][e.to] = e.label || '‚Üí'; });
            
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">';
            html += '<tr><th style="padding: 8px; border: 1px solid var(--border);"></th>';
            services.forEach(s => {
                const node = archState.nodes.find(n => n.id === s);
                html += `<th style="padding: 8px; border: 1px solid var(--border); writing-mode: vertical-rl; text-orientation: mixed; max-width: 40px;">${node?.service || s}</th>`;
            });
            html += '</tr>';
            
            services.forEach(from => {
                const fromNode = archState.nodes.find(n => n.id === from);
                html += `<tr><td style="padding: 8px; border: 1px solid var(--border); font-weight: 600;">${fromNode?.service || from}</td>`;
                services.forEach(to => {
                    const val = matrix[from][to];
                    const bg = val ? 'rgba(59, 130, 246, 0.2)' : '';
                    html += `<td style="padding: 8px; border: 1px solid var(--border); text-align: center; background: ${bg};">${val || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            
            container.innerHTML = html;
        }
        
        function renderTrafficFlow() {
            const container = document.getElementById('arch-traffic-flow');
            
            if (archState.nodes.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center;"><p style="color: var(--text-muted);">Deploy services to see traffic flow</p></div>';
                return;
            }
            
            // Group nodes by service for traffic flow display
            let html = '';
            
            archState.nodes.forEach(node => {
                const servers = node.servers || [];
                const hasMultipleServers = servers.length > 1;
                const hasDomain = node.domain;
                
                // Service card
                html += `
                <div style="margin-bottom: 24px; background: var(--bg-input); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="font-size: 1.2rem;">${node.type === 'stateful' ? 'üóÑÔ∏è' : '‚öôÔ∏è'}</span>
                        <span style="font-weight: 600; font-size: 1.1rem;">${node.service}</span>
                        <span class="badge" style="background: ${node.env === 'prod' ? 'var(--success)' : node.env === 'staging' ? 'var(--warning)' : 'var(--primary)'}; font-size: 0.7rem;">${node.env}</span>
                        ${hasDomain ? `<span style="font-size: 0.8rem; color: var(--text-muted);">‚Ä¢ ${node.domain}</span>` : ''}
                    </div>
                    
                    <!-- Traffic Flow Diagram -->
                    <div style="display: flex; align-items: stretch; gap: 0; overflow-x: auto; padding: 8px 0;">
                        
                        <!-- Client -->
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 80px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                                üë§
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Client</span>
                        </div>
                        
                        <!-- Arrow -->
                        <div style="display: flex; align-items: center; padding: 0 8px;">
                            <div style="width: 40px; height: 2px; background: linear-gradient(90deg, #6366f1, #f59e0b);"></div>
                            <div style="width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 8px solid #f59e0b;"></div>
                        </div>
                        
                        ${hasDomain ? `
                        <!-- Cloudflare -->
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 100px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f59e0b, #f97316); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                                ‚òÅÔ∏è
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">Cloudflare</span>
                            <span style="font-size: 0.65rem; color: var(--primary);">${node.domain}</span>
                        </div>
                        
                        <!-- Arrow -->
                        <div style="display: flex; align-items: center; padding: 0 8px;">
                            <div style="width: 30px; height: 2px; background: linear-gradient(90deg, #f59e0b, #10b981);"></div>
                            <div style="width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 8px solid #10b981;"></div>
                        </div>
                        ` : ''}
                        
                        <!-- Servers (Load Balanced if multiple) -->
                        <div style="display: flex; flex-direction: column; align-items: center; ${hasMultipleServers ? 'min-width: 200px;' : 'min-width: 120px;'}">
                            ${hasMultipleServers ? `
                            <div style="font-size: 0.7rem; color: var(--success); margin-bottom: 4px;">‚öñÔ∏è Load Balanced</div>
                            ` : ''}
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                ${servers.map((server, idx) => `
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; position: relative;">
                                        üñ•Ô∏è
                                        ${server.nginx_status === 'running' ? `<div style="position: absolute; bottom: -4px; right: -4px; width: 14px; height: 14px; background: var(--success); border-radius: 50%; border: 2px solid var(--bg-card); font-size: 8px; display: flex; align-items: center; justify-content: center;">‚úì</div>` : ''}
                                    </div>
                                    <span style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; font-family: monospace;">${server.ip}</span>
                                    <span style="font-size: 0.6rem; color: var(--primary);">:443</span>
                                </div>
                                `).join('')}
                            </div>
                            <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">nginx vhost</span>
                        </div>
                        
                        <!-- Arrow to containers -->
                        <div style="display: flex; align-items: center; padding: 0 8px;">
                            <div style="width: 30px; height: 2px; background: linear-gradient(90deg, #10b981, #3b82f6);"></div>
                            <div style="width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 8px solid #3b82f6;"></div>
                        </div>
                        
                        <!-- Containers -->
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 140px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                ${servers.map((server, idx) => `
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                                        üê≥
                                    </div>
                                    <span style="font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; font-family: monospace; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${node.container_name || node.id}</span>
                                    <span style="font-size: 0.6rem; color: var(--primary);">:${server.container_port || node.host_port || '?'}</span>
                                    ${node.container_port && node.host_port && node.container_port !== node.host_port ? `
                                    <span style="font-size: 0.55rem; color: var(--text-muted);">‚Üí app :${node.container_port}</span>
                                    ` : ''}
                                </div>
                                `).join('')}
                            </div>
                            <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">Docker containers</span>
                        </div>
                    </div>
                    
                    <!-- Connection details -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 0.8rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                            ${hasDomain ? `
                            <div>
                                <span style="color: var(--text-muted);">Domain:</span>
                                <a href="https://${node.domain}" target="_blank" style="color: var(--primary); margin-left: 4px;">${node.domain}</a>
                            </div>
                            ` : ''}
                            <div>
                                <span style="color: var(--text-muted);">Sidecar port:</span>
                                <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; margin-left: 4px;">localhost:${node.internal_port || '?'}</code>
                            </div>
                            ${node.host_port ? `
                            <div>
                                <span style="color: var(--text-muted);">Host port:</span>
                                <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; margin-left: 4px;">${node.host_port}</code>
                            </div>
                            ` : ''}
                            ${node.container_port ? `
                            <div>
                                <span style="color: var(--text-muted);">App port:</span>
                                <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; margin-left: 4px;">${node.container_port}</code>
                            </div>
                            ` : ''}
                            <div>
                                <span style="color: var(--text-muted);">Container:</span>
                                <code style="background: var(--bg-card); padding: 2px 6px; border-radius: 4px; margin-left: 4px;">${node.container_name || node.id}</code>
                            </div>
                            ${servers.length > 0 ? `
                            <div>
                                <span style="color: var(--text-muted);">Direct access:</span>
                                ${servers.map(s => `<a href="http://${s.ip}:${s.container_port || node.host_port || 8000}" target="_blank" style="color: var(--text-muted); margin-left: 4px; font-family: monospace; font-size: 0.75rem;">${s.ip}:${s.container_port || node.host_port || '?'}</a>`).join(', ')}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html || '<div class="empty-state" style="padding: 20px; text-align: center;"><p style="color: var(--text-muted);">No services to display</p></div>';
        }
        
        async function fixMissingNginx() {
            // Get servers missing nginx
            const missingServers = archState.servers
                .filter(s => s.nginx_status !== 'running')
                .map(s => s.ip);
            
            if (missingServers.length === 0) {
                toast('All servers already have nginx running', 'info');
                return;
            }
            
            toast(`Fixing ${missingServers.length} server${missingServers.length > 1 ? 's' : ''}...`, 'info');
            
            try {
                const result = await api('POST', '/infra/nginx/ensure', {
                    server_ips: missingServers,
                    do_token: getCookie('do_token'),
                });
                
                if (result.success) {
                    toast(`‚úÖ Fixed ${result.fixed} server${result.fixed !== 1 ? 's' : ''}, ${result.already_ok} already OK`, 'success');
                } else {
                    toast(`‚ö†Ô∏è ${result.message}`, 'warning');
                }
                
                // Reload architecture to refresh status
                await loadArchitecture();
                
            } catch (e) {
                console.error('Failed to fix nginx:', e);
                toast('Failed to fix nginx: ' + e.message, 'error');
            }
        }
        
        // =============================================================================
        // Logs Tab Functions
        // =============================================================================
        
        let logsCache = { projects: [], servers: [], containers: {} };
        
        async function refreshLogsFilters() {
            try {
                // Load projects list
                const projectsResult = await api('GET', '/infra/projects');
                logsCache.projects = projectsResult.projects || [];
                
                // Populate project dropdown
                const projectSelect = document.getElementById('logs-project-filter');
                const currentProject = projectSelect.value;
                projectSelect.innerHTML = '<option value="">All Projects</option>' + 
                    logsCache.projects.map(p => `<option value="${p}"${p === currentProject ? ' selected' : ''}>${p}</option>`).join('');
                
                // Also update server project filter dropdown
                const serverProjectSelect = document.getElementById('server-project-filter');
                if (serverProjectSelect) {
                    const serverCurrentProject = serverProjectSelect.value;
                    serverProjectSelect.innerHTML = '<option value="">All Projects</option>' + 
                        logsCache.projects.map(p => `<option value="${p}"${p === serverCurrentProject ? ' selected' : ''}>${p}</option>`).join('');
                }
                
                // Load servers based on current filters
                await onLogsProjectChange();
            } catch (err) {
                console.error('Failed to load logs filters:', err);
            }
        }
        
        async function onLogsProjectChange() {
            const project = document.getElementById('logs-project-filter').value;
            const env = document.getElementById('logs-env-filter').value;
            
            // Load servers for this project/env
            let params = [];
            if (project) params.push(`project=${encodeURIComponent(project)}`);
            if (env) params.push(`environment=${encodeURIComponent(env)}`);
            
            try {
                const result = await api('GET', `/infra/servers${params.length ? '?' + params.join('&') : ''}`);
                logsCache.servers = (result.servers || []).filter(s => s.status === 'active' && s.ip);
                
                // Populate server dropdown
                const serverSelect = document.getElementById('logs-server-filter');
                serverSelect.innerHTML = '<option value="">All Servers (' + logsCache.servers.length + ')</option>' + 
                    logsCache.servers.map(s => `<option value="${s.ip}">${s.name} (${s.ip})</option>`).join('');
                
                // Clear container dropdown
                document.getElementById('logs-container-filter').innerHTML = '<option value="">Select Server First</option>';
            } catch (err) {
                console.error('Failed to load servers:', err);
            }
        }
        
        function onLogsEnvChange() {
            onLogsProjectChange();
        }
        
        async function onLogsServerChange() {
            const serverIp = document.getElementById('logs-server-filter').value;
            const containerSelect = document.getElementById('logs-container-filter');
            
            if (!serverIp) {
                containerSelect.innerHTML = '<option value="">Select Server First</option>';
                return;
            }
            
            try {
                const result = await api('GET', `/infra/agent/${serverIp}/containers`);
                const containers = result.containers || [];
                logsCache.containers[serverIp] = containers;
                
                containerSelect.innerHTML = '<option value="">Select Container</option>' + 
                    containers.map(c => {
                        // Docker CLI returns Names as string, Docker API returns array
                        const name = typeof c.Names === 'string' 
                            ? c.Names 
                            : (c.Names?.[0]?.replace(/^\//, '') || c.Id?.substring(0, 12) || 'unknown');
                        const status = c.State || c.Status || '';
                        const statusIcon = status.includes('running') ? 'üü¢' : status.includes('exited') ? 'üî¥' : '‚ö™';
                        return `<option value="${name}">${statusIcon} ${name}</option>`;
                    }).join('');
            } catch (err) {
                containerSelect.innerHTML = '<option value="">Error loading containers</option>';
                console.error('Failed to load containers:', err);
            }
        }
        
        async function loadContainerLogs() {
            const serverIp = document.getElementById('logs-server-filter').value;
            const containerName = document.getElementById('logs-container-filter').value;
            
            if (!serverIp || !containerName) {
                showToast('Select a server and container first', 'warning');
                return;
            }
            
            try {
                const result = await api('GET', `/infra/agent/${serverIp}/containers/${containerName}/logs?lines=500`);
                
                let logs = 'No logs available';
                if (typeof result === 'string') {
                    logs = result;
                } else if (result?.logs) {
                    logs = result.logs;
                } else if (result?.data?.logs) {
                    logs = result.data.logs;
                }
                
                document.getElementById('logs-title').textContent = `üìã ${containerName} @ ${serverIp}`;
                document.getElementById('logs-content').textContent = logs;
                document.getElementById('logs-output').style.display = 'block';
                
                // Scroll to bottom of logs
                const logsContent = document.getElementById('logs-content');
                logsContent.scrollTop = logsContent.scrollHeight;
            } catch (err) {
                showToast('Failed to load logs: ' + err.message, 'error');
            }
        }
        
        // =============================================================================
        // Deployment
        // =============================================================================
        
        // Friendly name generator - matches infra/utils/naming.py generate_friendly_name()
        const ADJECTIVES = [
            "brave", "calm", "eager", "fancy", "gentle", "happy", "jolly", "kind",
            "lively", "merry", "nice", "proud", "quick", "sharp", "swift", "wise",
            "bold", "bright", "cool", "daring", "epic", "fast", "grand", "keen"
        ];
        const NOUNS = [
            "tiger", "eagle", "wolf", "falcon", "lion", "bear", "hawk", "fox",
            "otter", "raven", "shark", "whale", "cobra", "puma", "lynx", "elk",
            "owl", "swan", "crane", "heron", "dragon", "phoenix", "panther", "jaguar"
        ];
        
        function generateFriendlyName() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            return `${adj}-${noun}`;
        }
        
        function toggleDeploySource() {
            const source = document.querySelector('input[name="deploy-source"]:checked').value;
            document.getElementById('deploy-source-code').style.display = source === 'code' ? 'block' : 'none';
            document.getElementById('deploy-source-git').style.display = source === 'git' ? 'block' : 'none';
            document.getElementById('deploy-source-image').style.display = source === 'image' ? 'block' : 'none';
            document.getElementById('deploy-source-image-file').style.display = source === 'image_file' ? 'block' : 'none';
            // Infra section is shared for code, git, and image_file deploy modes
            document.getElementById('deploy-infra-section').style.display = (source === 'code' || source === 'git' || source === 'image_file') ? 'block' : 'none';
            // App Port is for code/git (image_file has its own container/host port fields)
            document.getElementById('deploy-app-port-section').style.display = (source === 'code' || source === 'git' || source === 'image') ? 'block' : 'none';
        }
        
        // Toggle dependencies section based on auto-env checkbox
        function toggleAutoEnvDeps() {
            const autoEnv = document.getElementById('deploy-auto-env')?.checked;
            const depsSection = document.getElementById('deploy-dependencies-section');
            if (depsSection) {
                depsSection.style.display = autoEnv ? 'block' : 'none';
            }
        }
        
        // Initialize auto-env toggle on page load
        document.addEventListener('DOMContentLoaded', () => {
            const autoEnvCheckbox = document.getElementById('deploy-auto-env');
            if (autoEnvCheckbox) {
                autoEnvCheckbox.addEventListener('change', toggleAutoEnvDeps);
            }
        });
        
        // Toggle server list collapsible
        function toggleServerList() {
            const content = document.getElementById('deploy-server-list');
            const header = content.previousElementSibling;
            content.classList.toggle('collapsed');
            header.querySelector('.collapse-icon').style.transform = content.classList.contains('collapsed') ? 'rotate(-90deg)' : '';
        }
        
        // Select/unselect all servers
        function selectAllServers(select) {
            document.querySelectorAll('#deploy-server-tbody input[type="checkbox"]').forEach(cb => {
                cb.checked = select;
            });
            updateServerCount();
        }
        
        // Update server count badge
        function updateServerCount() {
            const count = document.querySelectorAll('#deploy-server-tbody input[type="checkbox"]:checked').length;
            const badge = document.getElementById('deploy-server-count');
            if (badge) {
                badge.textContent = `${count} selected`;
                badge.className = count > 0 ? 'badge badge-success' : 'badge badge-info';
            }
        }
        
        // Number spinner +/- buttons
        function adjustServerCount(delta) {
            const input = document.getElementById('deploy-additional-servers');
            const newVal = Math.max(0, Math.min(10, parseInt(input.value || 0) + delta));
            input.value = newVal;
        }
        
        // Track last deploy to prevent duplicates
        let lastDeploySignature = null;
        
        function getDeploySignature() {
            const name = document.getElementById('deploy-name').value;
            const sourceType = document.querySelector('input[name="deploy-source"]:checked').value;
            const serverIps = getSelectedServers().map(s => s.ip).sort().join(',');
            const newCount = document.getElementById('deploy-additional-servers').value;
            return `${name}|${sourceType}|${serverIps}|${newCount}`;
        }
        
        function checkDuplicateDeploy() {
            const sig = getDeploySignature();
            if (sig === lastDeploySignature) {
                return !confirm('‚ö†Ô∏è You just deployed with these same settings. Deploy again?');
            }
            return false;
        }
        
        // =============================================================================
        // Domain Configuration
        // =============================================================================
        
        function onSetupDomainChange() {
            const setupDomain = document.getElementById('deploy-setup-domain').checked;
            const details = document.getElementById('deploy-domain-details');
            details.style.display = setupDomain ? 'block' : 'none';
            
            if (setupDomain) {
                updateDomainPreview();
                // Check for CF token
                if (!getCFToken()) {
                    showToast('Remember to save your Cloudflare token in Settings', 'warning');
                }
            }
        }
        
        function updateDomainPreview() {
            const name = document.getElementById('deploy-name').value || 'service';
            const project = document.getElementById('deploy-project').value || name;
            const env = document.getElementById('deploy-environment').value || 'prod';
            const baseDomain = document.getElementById('deploy-base-domain').value || 'digitalpixo.com';
            
            // Get workspace ID (truncated user ID) - simulating what backend does
            const workspaceId = state.user?.id?.toString().slice(0, 6) || 'user';
            
            // Convert to subdomain format (replace _ with -)
            const subdomain = `${workspaceId}-${project}-${env}-${name}`.toLowerCase().replace(/_/g, '-');
            
            const preview = document.getElementById('deploy-domain-preview');
            if (preview) {
                preview.textContent = `${subdomain}.${baseDomain}`;
            }
        }
        
        // Update domain preview when relevant fields change
        document.addEventListener('DOMContentLoaded', () => {
            ['deploy-name', 'deploy-project', 'deploy-environment'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateDomainPreview);
                    el.addEventListener('change', updateDomainPreview);
                }
            });
        });
        
        // =============================================================================
        // Dockerfile Preview (before deploy)
        // =============================================================================
        
        let pendingDockerfile = null;  // Stores dockerfile from preview
        let pendingCodeFile = null;    // Stores the file/blob to upload (zip or folder-zipped)
        
        function selectCodeZip() {
            // Reset to ensure onchange fires even for same file
            document.getElementById('deploy-file').value = '';
            document.getElementById('deploy-file').click();
        }
        
        function selectCodeFolder() {
            // Reset to ensure onchange fires even for same folder
            document.getElementById('deploy-folder').value = '';
            document.getElementById('deploy-folder').click();
        }
        
        async function onCodeFileSelected(input) {
            const file = input.files[0];
            const preview = document.getElementById('dockerfile-preview');
            const editor = document.getElementById('dockerfile-editor-preview');
            const badge = document.getElementById('dockerfile-preview-badge');
            const info = document.getElementById('code-selection-info');
            
            if (!file) {
                preview.style.display = 'none';
                pendingDockerfile = null;
                pendingCodeFile = null;
                info.innerHTML = 'No code selected';
                return;
            }
            
            // Store the file for upload
            pendingCodeFile = file;
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            info.innerHTML = `üì¶ <strong>${file.name}</strong> (${sizeMB} MB)`;
            
            preview.style.display = 'block';
            editor.value = 'Reading archive...';
            badge.textContent = 'loading';
            badge.className = 'badge badge-info';
            
            // Get port from main form
            const mainPort = document.getElementById('deploy-port').value;
            
            try {
                const dockerfile = await extractDockerfileFromZip(file);
                if (dockerfile) {
                    editor.value = dockerfile;
                    badge.textContent = 'from archive';
                    badge.className = 'badge badge-success';
                } else {
                    // Generate template based on detected files
                    const files = await listFilesInZip(file);
                    editor.value = generateDockerfileTemplate(files, mainPort);
                    badge.textContent = 'generated';
                    badge.className = 'badge badge-warning';
                }
                pendingDockerfile = editor.value;
                parseDockerfileToQuickFields();
            } catch (e) {
                console.error('Error reading zip:', e);
                editor.value = generateDockerfileTemplate([], mainPort);
                badge.textContent = 'template';
                badge.className = 'badge badge-info';
                pendingDockerfile = editor.value;
            }
        }
        
        async function onCodeFolderSelected(input) {
            const files = Array.from(input.files);
            const preview = document.getElementById('dockerfile-preview');
            const editor = document.getElementById('dockerfile-editor-preview');
            const badge = document.getElementById('dockerfile-preview-badge');
            const info = document.getElementById('code-selection-info');
            
            if (!files.length) {
                preview.style.display = 'none';
                pendingDockerfile = null;
                pendingCodeFile = null;
                info.innerHTML = 'No code selected';
                return;
            }
            
            // Show loading state
            info.innerHTML = `üìÅ Zipping ${files.length} files...`;
            preview.style.display = 'block';
            editor.value = 'Zipping folder...';
            badge.textContent = 'zipping';
            badge.className = 'badge badge-info';
            
            try {
                // Get folder name from first file's path
                const firstPath = files[0].webkitRelativePath;
                const folderName = firstPath.split('/')[0];
                
                // Create zip from folder contents
                const zip = new JSZip();
                
                // Track files for dockerfile detection
                const fileList = [];
                let existingDockerfile = null;
                
                for (const file of files) {
                    // Get path relative to selected folder (remove folder prefix)
                    const relativePath = file.webkitRelativePath.split('/').slice(1).join('/');
                    if (!relativePath) continue;  // Skip root folder entry
                    
                    // Skip common ignore patterns
                    if (shouldIgnoreFile(relativePath)) continue;
                    
                    fileList.push(relativePath);
                    
                    // Check for Dockerfile
                    if (relativePath === 'Dockerfile' || relativePath.toLowerCase() === 'dockerfile') {
                        existingDockerfile = await file.text();
                    }
                    
                    // Add file to zip
                    const content = await file.arrayBuffer();
                    zip.file(relativePath, content);
                }
                
                // Generate zip blob
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                // Create a File object from blob (for form upload)
                pendingCodeFile = new File([zipBlob], `${folderName}.zip`, { type: 'application/zip' });
                
                const sizeMB = (pendingCodeFile.size / 1024 / 1024).toFixed(2);
                const fileCount = fileList.length;
                info.innerHTML = `üìÅ <strong>${folderName}/</strong> ‚Üí ${fileCount} files (${sizeMB} MB zipped)`;
                
                // Get port from main form
                const mainPort = document.getElementById('deploy-port').value;
                
                // Set dockerfile
                if (existingDockerfile) {
                    editor.value = existingDockerfile;
                    badge.textContent = 'from folder';
                    badge.className = 'badge badge-success';
                } else {
                    editor.value = generateDockerfileTemplate(fileList, mainPort);
                    badge.textContent = 'generated';
                    badge.className = 'badge badge-warning';
                }
                pendingDockerfile = editor.value;
                parseDockerfileToQuickFields();
                
            } catch (e) {
                console.error('Error zipping folder:', e);
                info.innerHTML = `‚ùå Error: ${e.message}`;
                pendingCodeFile = null;
                pendingDockerfile = null;
            }
        }
        
        function shouldIgnoreFile(path) {
            // Common patterns to ignore when zipping folders
            const ignorePatterns = [
                /^\.git\//,
                /^\.git$/,
                /^node_modules\//,
                /^__pycache__\//,
                /\.pyc$/,
                /^\.venv\//,
                /^venv\//,
                /^\.env$/,
                /^\.DS_Store$/,
                /^\.idea\//,
                /^\.vscode\//,
                /^dist\//,
                /^build\//,
                /^\.pytest_cache\//,
                /^\.mypy_cache\//,
                /^\.coverage$/,
                /^coverage\//,
                /^htmlcov\//,
                /^\.tox\//,
                /^\.eggs\//,
                /\.egg-info\//,
            ];
            
            return ignorePatterns.some(pattern => pattern.test(path));
        }
        
        async function onImageFileSelected(input) {
            const file = input.files[0];
            const nameInput = document.getElementById('deploy-image-file-name');
            const nameHint = document.getElementById('deploy-image-file-name-hint');
            const containerPortInput = document.getElementById('deploy-image-file-container-port');
            const hostPortInput = document.getElementById('deploy-image-file-host-port');
            
            if (!file) {
                nameInput.value = '';
                nameHint.textContent = 'Will be detected from tar file';
                nameHint.style.color = 'var(--text-muted)';
                return;
            }
            
            nameHint.textContent = 'Reading tar file...';
            nameHint.style.color = 'var(--text-muted)';
            
            try {
                const manifest = await extractManifestFromTar(file);
                if (manifest && manifest.RepoTags && manifest.RepoTags.length > 0) {
                    const imageName = manifest.RepoTags[0];
                    nameInput.value = imageName;
                    nameHint.textContent = `‚úÖ Detected: ${imageName}`;
                    nameHint.style.color = 'var(--success)';
                    
                    // Try to get exposed port from config
                    if (manifest.Config) {
                        try {
                            const configData = await extractFileFromTar(file, manifest.Config);
                            if (configData) {
                                const config = JSON.parse(configData);
                                if (config.config && config.config.ExposedPorts) {
                                    const ports = Object.keys(config.config.ExposedPorts);
                                    if (ports.length > 0) {
                                        const port = parseInt(ports[0].split('/')[0]);
                                        containerPortInput.value = port;
                                        hostPortInput.value = port;
                                        nameHint.textContent = `‚úÖ Detected: ${imageName} (port ${port})`;
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('Could not extract config for port detection:', e);
                        }
                    }
                } else {
                    nameHint.textContent = '‚ö†Ô∏è Could not detect image name - enter manually';
                    nameHint.style.color = 'var(--warning)';
                    nameInput.readOnly = false;
                    nameInput.style.background = '';
                    nameInput.placeholder = 'myapp:latest';
                }
            } catch (e) {
                console.error('Error reading tar:', e);
                nameHint.textContent = '‚ö†Ô∏è Could not read tar - enter name manually';
                nameHint.style.color = 'var(--warning)';
                nameInput.readOnly = false;
                nameInput.style.background = '';
                nameInput.placeholder = 'myapp:latest';
            }
        }
        
        async function extractManifestFromTar(file) {
            // Parse tar file to find manifest.json
            const content = await extractFileFromTar(file, 'manifest.json');
            if (content) {
                const manifest = JSON.parse(content);
                return manifest[0];  // manifest.json is an array with one element
            }
            return null;
        }
        
        async function extractFileFromTar(file, targetName) {
            // Simple tar parser - tar format has 512-byte headers
            const buffer = await file.arrayBuffer();
            const view = new Uint8Array(buffer);
            
            let offset = 0;
            while (offset < view.length - 512) {
                // Read filename from header (first 100 bytes, null-terminated)
                let filename = '';
                for (let i = 0; i < 100 && view[offset + i] !== 0; i++) {
                    filename += String.fromCharCode(view[offset + i]);
                }
                
                if (!filename) break;  // Empty header = end of archive
                
                // Read file size from header (offset 124, 12 bytes, octal string)
                let sizeStr = '';
                for (let i = 0; i < 11 && view[offset + 124 + i] !== 0; i++) {
                    sizeStr += String.fromCharCode(view[offset + 124 + i]);
                }
                const fileSize = parseInt(sizeStr.trim(), 8) || 0;
                
                // Check if this is the file we want
                if (filename === targetName || filename.endsWith('/' + targetName)) {
                    // File content starts at offset + 512
                    const contentStart = offset + 512;
                    const contentBytes = view.slice(contentStart, contentStart + fileSize);
                    return new TextDecoder().decode(contentBytes);
                }
                
                // Move to next file (header + content, both padded to 512 bytes)
                offset += 512 + Math.ceil(fileSize / 512) * 512;
            }
            
            return null;
        }
        
        async function extractDockerfileFromZip(file) {
            const JSZip = window.JSZip;
            if (!JSZip) {
                console.warn('JSZip not loaded, cannot extract Dockerfile');
                return null;
            }
            
            const zip = await JSZip.loadAsync(file);
            
            // Look for Dockerfile at various paths
            const candidates = [
                'Dockerfile',
                'dockerfile',
                // Handle nested folders (e.g., release/Dockerfile)
                ...Object.keys(zip.files).filter(f => f.endsWith('/Dockerfile') || f.endsWith('/dockerfile'))
            ];
            
            for (const path of candidates) {
                const entry = zip.file(path);
                if (entry) {
                    return await entry.async('string');
                }
            }
            
            // Check for Dockerfile in first-level subdirectory
            for (const [path, entry] of Object.entries(zip.files)) {
                if (!entry.dir && (path.split('/').length === 2) && 
                    (path.toLowerCase().endsWith('dockerfile'))) {
                    return await entry.async('string');
                }
            }
            
            return null;
        }
        
        async function listFilesInZip(file) {
            const JSZip = window.JSZip;
            if (!JSZip) return [];
            
            const zip = await JSZip.loadAsync(file);
            return Object.keys(zip.files).filter(f => !zip.files[f].dir);
        }
        
        function generateDockerfileTemplate(files, port = '8000') {
            const fileNames = files.map(f => f.split('/').pop().toLowerCase());
            const filePaths = files.map(f => f.toLowerCase());
            
            // Detect if there's a single root folder (e.g., release/...)
            const rootFolders = new Set();
            for (const path of files) {
                const parts = path.split('/');
                if (parts.length > 1 && parts[0]) {
                    rootFolders.add(parts[0]);
                }
            }
            const singleRootFolder = rootFolders.size === 1 ? [...rootFolders][0] : null;
            const pathPrefix = singleRootFolder ? singleRootFolder + '/' : '';
            
            // Detect project type
            const hasReqsTxt = fileNames.includes('requirements.txt');
            const hasPackageJson = fileNames.includes('package.json');
            const hasPyProject = fileNames.includes('pyproject.toml');
            const hasGoMod = fileNames.includes('go.mod');
            const hasPythonFiles = fileNames.some(f => f.endsWith('.py'));
            
            // Find entry point - check for services/ structure
            let entryPoint = 'main:app';
            let workdir = '/app';
            
            // Check for nested service structure (e.g., services/ai_agents_api/main.py or release/services/...)
            for (const path of filePaths) {
                // Handle both direct and nested paths
                const match = path.match(/(?:^|\/)services\/([^/]+)\/main\.py$/);
                if (match) {
                    entryPoint = `services.${match[1]}.main:app`;
                    break;
                }
            }
            
            // If no services/ found, look for direct main.py variants
            if (entryPoint === 'main:app') {
                for (const candidate of ['main.py', 'app.py', 'api.py', 'server.py', 'run.py']) {
                    if (fileNames.includes(candidate)) {
                        entryPoint = candidate.replace('.py', '') + ':app';
                        break;
                    }
                }
            }
            
            // Adjust workdir if single root folder detected
            if (singleRootFolder) {
                workdir = `/app/${singleRootFolder}`;
            }
            
            if (hasPythonFiles || hasReqsTxt || hasPyProject) {
                let dockerfile = `FROM python:3.11-slim
WORKDIR ${workdir}`;
                
                if (hasReqsTxt) {
                    dockerfile += `
COPY ${pathPrefix}requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt`;
                } else if (hasPyProject) {
                    dockerfile += `
COPY ${pathPrefix}pyproject.toml .
RUN pip install --no-cache-dir .`;
                } else {
                    dockerfile += `
# No requirements.txt found - add dependencies here
# RUN pip install --no-cache-dir fastapi uvicorn`;
                }
                
                dockerfile += `
COPY . /app
EXPOSE ${port}
CMD ["uvicorn", "${entryPoint}", "--host", "0.0.0.0", "--port", "${port}"]`;
                return dockerfile;
            }
            
            if (hasPackageJson) {
                return `FROM node:20-alpine
WORKDIR ${workdir}
COPY ${pathPrefix}package*.json ./
RUN npm install
COPY . /app
EXPOSE ${port}
CMD ["npm", "start"]`;
            }
            
            if (hasGoMod) {
                return `FROM golang:1.21-alpine
WORKDIR ${workdir}
COPY ${pathPrefix}go.mod ${pathPrefix}go.sum ./
RUN go mod download
COPY . /app
RUN go build -o main .
EXPOSE ${port}
CMD ["./main"]`;
            }
            
            // Default template
            return `FROM python:3.11-slim
WORKDIR ${workdir}
COPY . /app
# Add install command if needed
EXPOSE ${port}
CMD ["python", "main.py"]`;
        }
        
        function toggleDockerfilePreview() {
            const content = document.getElementById('dockerfile-preview-content');
            const btn = content.previousElementSibling.querySelector('button');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                btn.textContent = '‚ñ∂';
            }
        }
        
        function parseDockerfileToQuickFields() {
            const text = document.getElementById('dockerfile-editor-preview').value;
            const lines = text.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('FROM ')) {
                    const val = trimmed.substring(5).trim().split(' ')[0];
                    const select = document.getElementById('dockerfile-quick-from');
                    for (let opt of select.options) {
                        if (opt.value === val) { 
                            select.value = val; 
                            break; 
                        }
                    }
                } else if (trimmed.startsWith('EXPOSE ')) {
                    // Sync EXPOSE to main port field
                    document.getElementById('deploy-port').value = trimmed.substring(7).trim();
                } else if (trimmed.startsWith('CMD ')) {
                    document.getElementById('dockerfile-quick-cmd').value = trimmed.substring(4).trim();
                }
            }
        }
        
        function updateDockerfilePreviewField(field) {
            const editor = document.getElementById('dockerfile-editor-preview');
            let lines = editor.value.split('\n');
            
            if (field === 'from') {
                const newFrom = document.getElementById('dockerfile-quick-from').value;
                if (newFrom) {
                    lines = lines.map(l => l.trim().startsWith('FROM ') ? `FROM ${newFrom}` : l);
                }
            } else if (field === 'cmd') {
                const newCmd = document.getElementById('dockerfile-quick-cmd').value;
                if (newCmd) {
                    // Format as JSON array if it looks like a command
                    let cmdValue = newCmd;
                    if (!newCmd.startsWith('[')) {
                        const parts = newCmd.match(/(?:[^\s"]+|"[^"]*")+/g) || [newCmd];
                        cmdValue = JSON.stringify(parts);
                    }
                    lines = lines.map(l => l.trim().startsWith('CMD ') ? `CMD ${cmdValue}` : l);
                }
            }
            
            editor.value = lines.join('\n');
            pendingDockerfile = editor.value;
        }
        
        function updateDockerfilePort() {
            const port = document.getElementById('deploy-port').value;
            
            // Update preview editor (Local Code flow)
            const previewEditor = document.getElementById('dockerfile-editor-preview');
            if (previewEditor && previewEditor.value) {
                let lines = previewEditor.value.split('\n');
                lines = lines.map(l => {
                    const trimmed = l.trim();
                    if (trimmed.startsWith('EXPOSE ')) {
                        return `EXPOSE ${port}`;
                    }
                    if (trimmed.startsWith('CMD ') && trimmed.includes('--port')) {
                        // Replace port in CMD like: CMD ["uvicorn", "...", "--port", "8000"]
                        return l.replace(/("--port",\s*")(\d+)(")/, `$1${port}$3`);
                    }
                    return l;
                });
                previewEditor.value = lines.join('\n');
                pendingDockerfile = previewEditor.value;
            }
            
            // Update review editor (Git flow)
            const reviewEditor = document.getElementById('dockerfile-review-editor');
            if (reviewEditor && reviewEditor.value) {
                let lines = reviewEditor.value.split('\n');
                lines = lines.map(l => {
                    const trimmed = l.trim();
                    if (trimmed.startsWith('EXPOSE ')) {
                        return `EXPOSE ${port}`;
                    }
                    if (trimmed.startsWith('CMD ') && trimmed.includes('--port')) {
                        return l.replace(/("--port",\s*")(\d+)(")/, `$1${port}$3`);
                    }
                    return l;
                });
                reviewEditor.value = lines.join('\n');
            }
        }
        
        // Update dockerfile when textarea is edited directly
        document.addEventListener('DOMContentLoaded', () => {
            const editor = document.getElementById('dockerfile-editor-preview');
            if (editor) {
                editor.addEventListener('input', () => {
                    pendingDockerfile = editor.value;
                });
            }
        });
        
        // =============================================================================
        // Dockerfile Review (inline during deploy - for git flow)
        // =============================================================================
        
        function showDockerfileReview(dockerfileResult, port) {
            return new Promise((resolve) => {
                const panel = document.getElementById('deploy-dockerfile-review');
                const editor = document.getElementById('dockerfile-review-editor');
                const badge = document.getElementById('dockerfile-review-badge');
                const continueBtn = document.getElementById('dockerfile-review-continue');
                
                // Set content
                editor.value = dockerfileResult.dockerfile || generateDockerfileTemplate([], port);
                
                // Set badge
                if (dockerfileResult.source === 'existing') {
                    badge.textContent = 'from repo';
                    badge.className = 'badge badge-success';
                } else if (dockerfileResult.source === 'generated') {
                    badge.textContent = 'auto-generated';
                    badge.className = 'badge badge-warning';
                } else {
                    badge.textContent = 'template';
                    badge.className = 'badge badge-info';
                }
                
                // Parse to quick fields (also syncs EXPOSE to main port field)
                parseDockerfileReviewToFields();
                
                // Show panel
                panel.style.display = 'block';
                
                // Wire up continue button
                const handler = () => {
                    panel.style.display = 'none';
                    continueBtn.removeEventListener('click', handler);
                    resolve(editor.value);
                };
                continueBtn.addEventListener('click', handler);
            });
        }
        
        function parseDockerfileReviewToFields() {
            const text = document.getElementById('dockerfile-review-editor').value;
            const lines = text.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('FROM ')) {
                    const val = trimmed.substring(5).trim().split(' ')[0];
                    const select = document.getElementById('dockerfile-review-from');
                    for (let opt of select.options) {
                        if (opt.value === val) { 
                            select.value = val; 
                            break; 
                        }
                    }
                } else if (trimmed.startsWith('EXPOSE ')) {
                    // Sync to main port field
                    document.getElementById('deploy-port').value = trimmed.substring(7).trim();
                } else if (trimmed.startsWith('CMD ')) {
                    document.getElementById('dockerfile-review-cmd').value = trimmed.substring(4).trim();
                }
            }
        }
        
        function updateDockerfileReviewField(field) {
            const editor = document.getElementById('dockerfile-review-editor');
            let lines = editor.value.split('\n');
            
            if (field === 'from') {
                const newFrom = document.getElementById('dockerfile-review-from').value;
                if (newFrom) {
                    lines = lines.map(l => l.trim().startsWith('FROM ') ? `FROM ${newFrom}` : l);
                }
            } else if (field === 'cmd') {
                const newCmd = document.getElementById('dockerfile-review-cmd').value;
                if (newCmd) {
                    let cmdValue = newCmd;
                    if (!newCmd.startsWith('[')) {
                        const parts = newCmd.match(/(?:[^\s"]+|"[^"]*")+/g) || [newCmd];
                        cmdValue = JSON.stringify(parts);
                    }
                    lines = lines.map(l => l.trim().startsWith('CMD ') ? `CMD ${cmdValue}` : l);
                }
            }
            
            editor.value = lines.join('\n');
        }
        
        async function loadSnapshotsForDeploy() {
            if (!hasDoToken()) return;
            
            try {
                const result = await api('GET', '/infra/snapshots');
                const snapshots = result.snapshots || [];
                state.snapshots = snapshots;
                
                // Store regions in data attribute for filtering
                const options = '<option value="">Select a snapshot...</option>' + 
                    snapshots.map(s => {
                        const regions = (s.regions || []).join(',');
                        return `<option value="${s.id}" data-name="${s.name}" data-regions="${regions}">${s.name} (${s.size_gigabytes} GB)</option>`;
                    }).join('');
                
                document.getElementById('deploy-snapshot').innerHTML = options;
                document.getElementById('deploy-image-snapshot').innerHTML = options;
                
                // Auto-select "base" snapshot if available
                const baseSnapshot = snapshots.find(s => s.name && s.name.toLowerCase().includes('base'));
                if (baseSnapshot) {
                    document.getElementById('deploy-snapshot').value = baseSnapshot.id;
                    document.getElementById('deploy-image-snapshot').value = baseSnapshot.id;
                    onSnapshotChange();  // Update regions
                }
            } catch (e) {
                console.error('Failed to load snapshots', e);
            }
            
            // Load servers for image deploy dropdown
            await loadServersForDeploy();
        }
        
        // Called when snapshot selection changes - updates available regions
        function onSnapshotChange() {
            const select = document.getElementById('deploy-snapshot');
            const selectedOption = select.selectedOptions[0];
            
            if (selectedOption && selectedOption.value) {
                const regionsStr = selectedOption.dataset.regions || '';
                const availableRegions = regionsStr ? regionsStr.split(',') : [];
                
                if (availableRegions.length > 0) {
                    updateRegionDropdown(availableRegions);
                }
            }
            
            // Re-render server list
            renderServerList();
        }
        
        // All possible regions with display names
        const ALL_REGIONS = [
            { slug: 'lon1', name: 'üá¨üáß London' },
            { slug: 'nyc1', name: 'üá∫üá∏ New York' },
            { slug: 'nyc3', name: 'üá∫üá∏ New York 3' },
            { slug: 'sfo1', name: 'üá∫üá∏ San Francisco' },
            { slug: 'sfo2', name: 'üá∫üá∏ San Francisco 2' },
            { slug: 'sfo3', name: 'üá∫üá∏ San Francisco 3' },
            { slug: 'ams3', name: 'üá≥üá± Amsterdam' },
            { slug: 'sgp1', name: 'üá∏üá¨ Singapore' },
            { slug: 'fra1', name: 'üá©üá™ Frankfurt' },
            { slug: 'tor1', name: 'üá®üá¶ Toronto' },
            { slug: 'blr1', name: 'üáÆüá≥ Bangalore' },
            { slug: 'syd1', name: 'üá¶üá∫ Sydney' },
        ];
        
        function updateRegionDropdown(availableRegions) {
            const regionSelect = document.getElementById('deploy-region');
            const currentValue = regionSelect.value;
            
            const regionsToShow = availableRegions && availableRegions.length > 0
                ? ALL_REGIONS.filter(r => availableRegions.includes(r.slug))
                : ALL_REGIONS.filter(r => ['lon1', 'nyc1', 'sfo1', 'ams3', 'sgp1', 'fra1'].includes(r.slug));
            
            regionSelect.innerHTML = regionsToShow.map(r => 
                `<option value="${r.slug}" ${r.slug === currentValue ? 'selected' : ''}>${r.name}</option>`
            ).join('');
            
            if (!regionsToShow.find(r => r.slug === currentValue) && regionsToShow.length > 0) {
                regionSelect.value = regionsToShow[0].slug;
            }
        }
        
        // Called when region or size changes
        function onInfraChange() {
            renderServerList();
        }
        
        // Render server list based on current dropdown values (React-style)
        function renderServerList() {
            const snapshotId = document.getElementById('deploy-snapshot')?.value || '';
            const region = document.getElementById('deploy-region')?.value || '';
            const size = document.getElementById('deploy-size')?.value || '';
            const tbody = document.getElementById('deploy-server-tbody');
            
            if (!tbody) return;
            
            const allServers = state.infraServers || [];
            
            // Filter by region, size, AND snapshot (snapshot determines pre-installed libs)
            const filtered = allServers.filter(s => {
                if (region && s.region !== region) return false;
                if (size && s.size !== size) return false;
                if (snapshotId && String(s.image?.id) !== String(snapshotId)) return false;
                return true;
            });
            
            console.log(`renderServerList: snap=${snapshotId}, region=${region}, size=${size} ‚Üí ${filtered.length}/${allServers.length} servers`);
            
            if (filtered.length > 0) {
                tbody.innerHTML = filtered.map(s => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 8px 10px; width: 30px;"><input type="checkbox" class="server-checkbox" value="${s.ip}" data-name="${s.name}" checked onchange="updateServerCount()"></td>
                        <td style="padding: 8px 10px; font-weight: 500;">${s.name}</td>
                        <td style="padding: 8px 10px; font-family: monospace; font-size: 0.85rem; color: var(--text-muted);">${s.ip}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="3" style="padding: 16px; text-align: center; color: var(--text-muted);">
                    No servers match: ${region || 'any region'} / ${size || 'any size'} / snapshot ${snapshotId || 'any'}<br>
                    <small>Set "New servers" to provision matching servers</small>
                </td></tr>`;
            }
            
            // Update count badge
            updateServerCount();
        }
        
        function getSelectedServers() {
            const checkboxes = document.querySelectorAll('#deploy-server-tbody .server-checkbox:checked');
            return Array.from(checkboxes).map(cb => ({ ip: cb.value, name: cb.dataset.name }));
        }
        
        async function loadServersForDeploy() {
            const select = document.getElementById('deploy-server');
            if (!hasDoToken()) {
                if (select) select.innerHTML = '<option value="">Configure DO token first</option>';
                return;
            }
            
            try {
                // Load all active servers (tag=all to skip default tag filter)
                const result = await api('GET', '/infra/servers?status=active&tag=all');
                const servers = result.servers || [];
                state.servers = servers;
                state.infraServers = servers;  // Store for filtering
                
                console.log('loadServersForDeploy: loaded', servers.length, 'servers');
                
                // Populate image deploy dropdown
                if (select) {
                    select.innerHTML = '<option value="">Select a server...</option>' + 
                        servers.map(s => {
                            const ip = s.ip || 'no-ip';
                            return `<option value="${ip}">${s.name} (${ip})</option>`;
                        }).join('');
                }
                
                // Initial render with default dropdown values
                renderServerList();
            } catch (e) {
                if (select) select.innerHTML = '<option value="">Error loading servers</option>';
            }
        }
        
        // =============================================================================
        // Services Tab Functions (Stateful Services)
        // =============================================================================
        
        async function loadServersForStateful() {
            const select = document.getElementById('stateful-server');
            if (!select) return;
            
            if (!hasDoToken()) {
                select.innerHTML = '<option value="">Configure DO token first</option>';
                return;
            }
            
            try {
                const result = await api('GET', '/infra/servers?status=active&tag=all');
                const servers = result.servers || [];
                
                select.innerHTML = '<option value="">Select server...</option>' + 
                    servers.map(s => {
                        const ip = s.ip || 'no-ip';
                        return `<option value="${ip}">${s.name} (${ip})</option>`;
                    }).join('');
            } catch (e) {
                select.innerHTML = '<option value="">Error loading servers</option>';
            }
        }
        
        async function deployStatefulService(event) {
            event.preventDefault();
            
            const serviceType = document.getElementById('stateful-service-type').value;
            const project = document.getElementById('stateful-project').value.trim();
            const environment = document.getElementById('stateful-environment').value;
            const serverIp = document.getElementById('stateful-server').value;
            
            if (!serviceType || !project || !serverIp) {
                showToast('Please fill all required fields', 'warning');
                return;
            }
            
            const resultEmpty = document.getElementById('stateful-result-empty');
            const resultDiv = document.getElementById('stateful-result');
            const resultContent = document.getElementById('stateful-result-content');
            
            // Show loading
            resultEmpty.style.display = 'none';
            resultDiv.classList.remove('hidden');
            resultContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                    <div>Deploying ${serviceType}...</div>
                </div>
            `;
            
            try {
                const doToken = getLocalDoToken();
                const response = await fetch(`${API_BASE}/infra/deploy/stateful`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_type: serviceType,
                        project: project,
                        environment: environment,
                        server_ip: serverIp,
                        do_token: doToken,
                    }),
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Deployment failed');
                }
                
                // Show success
                const conn = data.connection_info || {};
                resultContent.innerHTML = `
                    <div style="padding: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <span style="font-size: 1.5rem;">‚úÖ</span>
                            <span style="font-weight: 600; font-size: 1.1rem;">Deployed Successfully</span>
                        </div>
                        
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">Container</div>
                            <code style="font-size: 0.85rem;">${data.container_name}</code>
                        </div>
                        
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">Internal Port</div>
                            <div style="font-family: monospace; font-size: 1.2rem; color: var(--primary);">
                                localhost:${data.internal_port}
                            </div>
                            <small style="color: var(--text-muted);">Other containers connect to this port</small>
                        </div>
                        
                        ${conn.url ? `
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">Connection URL</div>
                            <div style="background: var(--bg-input); padding: 8px; border-radius: 4px; overflow-x: auto;">
                                <code style="font-size: 0.8rem; word-break: break-all;">${conn.url}</code>
                            </div>
                            <button class="btn btn-ghost btn-sm" style="margin-top: 8px;" onclick="navigator.clipboard.writeText('${conn.url}'); showToast('Copied!', 'success');">
                                üìã Copy URL
                            </button>
                        </div>
                        ` : ''}
                        
                        ${conn.password ? `
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 500; margin-bottom: 8px;">Credentials</div>
                            <div style="display: grid; gap: 8px; font-size: 0.85rem;">
                                ${conn.user ? `<div><span style="color: var(--text-muted);">User:</span> <code>${conn.user}</code></div>` : ''}
                                <div><span style="color: var(--text-muted);">Password:</span> <code>${conn.password}</code></div>
                                ${conn.database ? `<div><span style="color: var(--text-muted);">Database:</span> <code>${conn.database}</code></div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                showToast(`${serviceType} deployed successfully`, 'success');
                
            } catch (e) {
                resultContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <div style="font-size: 2rem; margin-bottom: 8px;">‚ùå</div>
                        <div style="font-weight: 500;">Deployment Failed</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">${e.message}</div>
                    </div>
                `;
                showToast(e.message, 'error');
            }
        }
        
        // Track deployment state
        let deployInProgress = false;
        
        async function startDeployment(event) {
            event.preventDefault();
            
            // Prevent duplicate deployments
            if (deployInProgress) {
                showToast('Deployment already in progress', 'warning');
                return;
            }
            
            // Check for duplicate deploy (same settings)
            if (checkDuplicateDeploy()) {
                return;
            }
            
            // Collect form data
            const sourceType = document.querySelector('input[name="deploy-source"]:checked').value;
            const name = document.getElementById('deploy-name').value;
            const project = document.getElementById('deploy-project').value.trim();
            const port = parseInt(document.getElementById('deploy-port').value) || 8000;
            const envText = document.getElementById('deploy-env').value;
            const environment = document.getElementById('deploy-environment').value;
            const tagsInput = document.getElementById('deploy-tags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            
            // Collect new service config options
            const autoEnv = document.getElementById('deploy-auto-env')?.checked || false;
            const persistData = document.getElementById('deploy-persist-data')?.checked || false;
            const dependsOn = [];
            document.querySelectorAll('.deploy-dep:checked').forEach(cb => {
                dependsOn.push(cb.value);
            });
            
            // Domain config
            const setupDomain = document.getElementById('deploy-setup-domain')?.checked || false;
            const baseDomain = document.getElementById('deploy-base-domain')?.value || 'digitalpixo.com';
            const domainAliasesText = document.getElementById('deploy-domain-aliases')?.value || '';
            const domainAliases = domainAliasesText ? domainAliasesText.split(',').map(a => a.trim()).filter(a => a) : [];
            
            // Check CF token if domain setup requested
            if (setupDomain && !getCFToken()) {
                alert('Please save your Cloudflare token in Settings before enabling domain setup');
                deployInProgress = false;
                const deployBtn = document.querySelector('#deploy-form button[type="submit"]');
                if (deployBtn) {
                    deployBtn.disabled = false;
                    deployBtn.innerHTML = 'üöÄ Deploy';
                }
                return;
            }
            
            // Parse env vars
            const env_vars = {};
            envText.split('\n').forEach(line => {
                const [key, ...rest] = line.split('=');
                if (key && rest.length) env_vars[key.trim()] = rest.join('=').trim();
            });
            
            // Basic validation
            if (!name) {
                alert('Please enter an app name');
                return;
            }
            
            // Mark deployment as in progress and disable button
            deployInProgress = true;
            const deployBtn = document.querySelector('#deploy-form button[type="submit"]');
            if (deployBtn) {
                deployBtn.disabled = true;
                deployBtn.innerHTML = '‚è≥ Deploying...';
            }
            
            // Show progress UI
            document.getElementById('deploy-empty').style.display = 'none';
            document.getElementById('deploy-result').style.display = 'none';
            document.getElementById('deploy-progress').style.display = 'block';
            document.getElementById('deploy-logs').innerHTML = '';
            document.getElementById('deploy-progress-bar').style.width = '0%';
            document.getElementById('deploy-dockerfile-review').style.display = 'none';
            
            function log(msg) {
                const logs = document.getElementById('deploy-logs');
                // Skip empty messages
                if (!msg || !msg.trim()) {
                    logs.innerHTML += '\n';
                    logs.scrollTop = logs.scrollHeight;
                    return;
                }
                // Skip timestamp for separator lines
                if (msg.startsWith('‚ïê‚ïê') || msg.startsWith('‚îÄ‚îÄ') || msg.trim() === '') {
                    logs.innerHTML += `${msg}\n`;
                } else {
                    const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    logs.innerHTML += `<span style="color: var(--text-muted); font-size: 0.8em;">[${time}]</span> ${msg}\n`;
                }
                logs.scrollTop = logs.scrollHeight;
            }
            
            function progress(pct) {
                document.getElementById('deploy-progress-bar').style.width = pct + '%';
            }
            
            // Helper to reset button state
            function resetDeployButton() {
                deployInProgress = false;
                if (deployBtn) {
                    deployBtn.disabled = false;
                    deployBtn.innerHTML = 'üöÄ Deploy';
                }
            }
            
            try {
                // Build FormData payload (multipart - memory efficient)
                const formData = new FormData();
                formData.append('name', name);
                formData.append('port', port.toString());
                formData.append('env_vars', JSON.stringify(env_vars));
                formData.append('environment', environment);
                formData.append('tags', JSON.stringify(tags));
                formData.append('source_type', sourceType);
                if (project) formData.append('project', project);
                
                // Infrastructure
                formData.append('server_ips', JSON.stringify(getSelectedServers().map(s => s.ip)));
                formData.append('new_server_count', (parseInt(document.getElementById('deploy-additional-servers')?.value) || 0).toString());
                formData.append('snapshot_id', document.getElementById('deploy-snapshot').value || '');
                formData.append('region', document.getElementById('deploy-region').value || 'lon1');
                formData.append('size', document.getElementById('deploy-size').value || 's-1vcpu-1gb');
                
                // Track file for size logging
                let uploadFile = null;
                
                // Source-specific data
                if (sourceType === 'code') {
                    // Use pendingCodeFile (from zip OR from folder-zipped)
                    if (!pendingCodeFile) throw new Error('Please select a code file or folder');
                    
                    // Get dockerfile
                    const dockerfile = pendingDockerfile || document.getElementById('dockerfile-editor-preview')?.value;
                    if (!dockerfile?.trim()) throw new Error('No Dockerfile available');
                    formData.append('dockerfile', dockerfile);
                    
                    // Add file directly (no base64!)
                    formData.append('code_tar', pendingCodeFile);
                    uploadFile = pendingCodeFile;
                    
                } else if (sourceType === 'git') {
                    formData.append('git_url', document.getElementById('deploy-git-url').value);
                    formData.append('git_branch', document.getElementById('deploy-git-branch').value || 'main');
                    const gitToken = document.getElementById('deploy-git-token').value;
                    if (gitToken) formData.append('git_token', gitToken);
                    if (!document.getElementById('deploy-git-url').value) throw new Error('Please enter a Git repository URL');
                    
                } else if (sourceType === 'image') {
                    formData.append('image', document.getElementById('deploy-image').value);
                    if (!document.getElementById('deploy-image').value) throw new Error('Please enter a Docker image');
                    
                } else if (sourceType === 'image_file') {
                    const file = document.getElementById('deploy-image-file').files[0];
                    if (!file) throw new Error('Please select a Docker image file (.tar)');
                    
                    const imageName = document.getElementById('deploy-image-file-name').value;
                    if (!imageName) throw new Error('Please enter the image name');
                    
                    // For image_file, we use the streaming endpoint with raw body
                    uploadFile = file;
                    
                    // For image_file, use separate container/host ports
                    const containerPort = parseInt(document.getElementById('deploy-image-file-container-port').value) || 8000;
                    const hostPort = parseInt(document.getElementById('deploy-image-file-host-port').value) || containerPort;
                    
                    // Store for streaming endpoint
                    formData._useStreamingEndpoint = true;
                    formData._streamingParams = {
                        name,
                        image: imageName,
                        port: hostPort,
                        container_port: containerPort,
                        host_port: hostPort,
                        environment,
                        project: project || '',
                        env_vars: JSON.stringify(env_vars),
                        auto_env: autoEnv,
                        depends_on: JSON.stringify(dependsOn),
                        persist_data: persistData,
                    };
                    formData._streamingFile = file;
                }
                
                // Validate servers
                const serverIps = getSelectedServers().map(s => s.ip);
                const newServerCount = parseInt(document.getElementById('deploy-additional-servers')?.value) || 0;
                if (serverIps.length === 0 && newServerCount === 0) {
                    throw new Error('Select at least one server or set "New servers" > 0');
                }
                if (newServerCount > 0 && !document.getElementById('deploy-snapshot').value) {
                    throw new Error('Select a snapshot to provision new servers');
                }
                
                log(`üöÄ Starting deployment...`);
                progress(5);
                
                // Log upload size
                let uploadStart = Date.now();
                if (uploadFile) {
                    const sizeMB = (uploadFile.size / 1024 / 1024).toFixed(1);
                    log(`üì§ Uploading ${sizeMB}MB to server...`);
                }
                
                const doToken = getLocalDoToken();
                let response;
                
                // Use streaming endpoint for image_file (2x faster for existing servers)
                if (formData._useStreamingEndpoint) {
                    const cfToken = setupDomain ? getCFToken() : '';
                    const params = new URLSearchParams({
                        do_token: doToken,
                        cf_token: cfToken,
                        ...formData._streamingParams,
                        server_ips: JSON.stringify(serverIps),
                        new_server_count: newServerCount.toString(),
                        snapshot_id: document.getElementById('deploy-snapshot').value || '',
                        region: document.getElementById('deploy-region').value || 'lon1',
                        size: document.getElementById('deploy-size').value || 's-1vcpu-1gb',
                        setup_domain: setupDomain.toString(),
                        base_domain: baseDomain,
                        domain_aliases: JSON.stringify(domainAliases),
                    });
                    
                    // Two-phase for NEW servers (enables tee-streaming after provision)
                    // For multiple servers, tee-streaming is used (parallel upload to all)
                    
                    if (newServerCount > 0) {
                        log(`‚ö° Two-phase deploy: preparing ${newServerCount} new server(s) first...`);
                        
                        const prepareBody = {
                            do_token: doToken,
                            server_ips: serverIps,  // Include existing servers too
                            new_server_count: newServerCount,
                            snapshot_id: document.getElementById('deploy-snapshot').value || '',
                            region: document.getElementById('deploy-region').value || 'lon1',
                            size: document.getElementById('deploy-size').value || 's-1vcpu-1gb',
                            project: project || undefined,
                            environment,
                        };
                        
                        const prepareResp = await fetch(`${API_BASE}/infra/deploy/prepare`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${state.token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(prepareBody),
                        });
                        
                        if (!prepareResp.ok) {
                            const err = await prepareResp.json();
                            throw new Error(err.detail || 'Prepare failed');
                        }
                        
                        const prepareData = await prepareResp.json();
                        log(`‚úÖ ${prepareData.ready_ips.length} server(s) ready`);
                        for (const ip of prepareData.ready_ips) {
                            log(`   ‚Ä¢ ${ip}`);
                        }
                        
                        // Now stream with session_id (true streaming!)
                        const streamParams = new URLSearchParams({
                            session_id: prepareData.session_id,
                            name,
                            image: formData._streamingParams.image,
                            port: formData._streamingParams.port,
                            container_port: formData._streamingParams.container_port,
                            host_port: formData._streamingParams.host_port,
                            environment,
                            project: project || '',
                            env_vars: formData._streamingParams.env_vars || '{}',
                            auto_env: formData._streamingParams.auto_env || false,
                            depends_on: formData._streamingParams.depends_on || '[]',
                            persist_data: formData._streamingParams.persist_data || false,
                        });
                        
                        log(`üî® Streaming image directly to ${prepareData.ready_ips.length} server(s)...`);
                        uploadStart = Date.now();
                        
                        response = await fetch(`${API_BASE}/infra/deploy/stream?${streamParams}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${state.token}`,
                                'Content-Type': 'application/octet-stream',
                            },
                            body: formData._streamingFile,
                        });
                    } else {
                        // Existing servers only - direct streaming (single) or tee-streaming (multiple)
                        const mode = serverIps.length > 1 ? 'tee-streaming' : 'true streaming';
                        log(`‚ö° Using ${mode} (fastest path)...`);
                        
                        response = await fetch(`${API_BASE}/infra/deploy/stream?${params}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${state.token}`,
                                'Content-Type': 'application/octet-stream',
                            },
                            body: formData._streamingFile,
                        });
                    }
                } else {
                    // Use multipart for code/git/image
                    const projectVal = document.getElementById('deploy-project').value.trim();
                    const environmentVal = document.getElementById('deploy-environment').value;
                    const cfToken = setupDomain ? getCFToken() : '';
                    response = await fetch(`${API_BASE}/infra/deploy/multipart?do_token=${encodeURIComponent(doToken)}&cf_token=${encodeURIComponent(cfToken)}&snapshot_id=${encodeURIComponent(document.getElementById('deploy-snapshot').value || '')}&new_server_count=${newServerCount}&region=${encodeURIComponent(document.getElementById('deploy-region').value || 'lon1')}&size=${encodeURIComponent(document.getElementById('deploy-size').value || 's-1vcpu-1gb')}&project=${encodeURIComponent(projectVal)}&environment=${encodeURIComponent(environmentVal)}&setup_domain=${setupDomain}&base_domain=${encodeURIComponent(baseDomain)}&domain_aliases=${encodeURIComponent(JSON.stringify(domainAliases))}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                        },
                        body: formData,
                    });
                }
                
                // Log upload complete
                const uploadSec = ((Date.now() - uploadStart) / 1000).toFixed(1);
                log(`‚úÖ Upload complete (${uploadSec}s)`);
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Deploy request failed');
                }
                
                // Read SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let result = null;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const msg = JSON.parse(line.slice(6));
                                
                                if (msg.type === 'log') {
                                    log(msg.message);
                                } else if (msg.type === 'progress') {
                                    progress(msg.percent);
                                } else if (msg.type === 'done') {
                                    result = msg;
                                }
                            } catch (e) {}
                        }
                    }
                }
                
                progress(100);
                
                // Show result
                if (result?.success) {
                    const successfulServers = (result.servers || []).filter(s => s.success);
                    const failedServers = (result.servers || []).filter(s => !s.success);
                    
                    log(`\nüéâ Deployment complete!`);
                    successfulServers.forEach(s => log(`   üåê ${s.url}`));
                    failedServers.forEach(s => log(`   ‚ùå ${s.ip}: ${s.error || 'Failed'}`));
                    
                    // Track last deploy to prevent accidental re-deploys
                    lastDeploySignature = getDeploySignature();
                    
                    window.lastDeployment = { 
                        serverIps: successfulServers.map(s => s.ip), 
                        name, port, environment, tags 
                    };
                    
                    const envColor = environment === 'prod' ? '#dc2626' : 
                                     environment === 'staging' || environment === 'uat' ? '#f59e0b' : '#22c55e';
                    const tagsHtml = tags.length > 0 ? `<div style="margin-top: 4px;">${tags.map(t => 
                        `<span style="background: rgba(255,255,255,0.2); padding: 1px 6px; border-radius: 3px; font-size: 0.7rem; margin-right: 4px;">${t}</span>`
                    ).join('')}</div>` : '';
                    
                    // Show partial success if some failed
                    const hasFailures = failedServers.length > 0;
                    const statusBg = hasFailures ? 'linear-gradient(135deg, var(--success) 0%, #f59e0b 100%)' : 'var(--success)';
                    const statusText = hasFailures 
                        ? `‚ö†Ô∏è Partially Deployed (${successfulServers.length}/${successfulServers.length + failedServers.length} servers)`
                        : '‚úÖ Deployment Successful!';
                    
                    // Domain info (if provisioned)
                    const domainInfo = result.domain ? `
                        <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 6px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">üåê Domain</div>
                            <a href="https://${result.domain}" target="_blank" style="color: white; font-size: 1.1rem;">https://${result.domain}</a>
                            ${result.domain_aliases?.length ? `
                                <div style="margin-top: 6px; font-size: 0.85rem; color: rgba(255,255,255,0.8);">
                                    Aliases: ${result.domain_aliases.map(a => `<a href="https://${a}" target="_blank" style="color: inherit;">${a}</a>`).join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    ` : '';
                    
                    document.getElementById('deploy-result').style.display = 'block';
                    document.getElementById('deploy-result').innerHTML = `
                        <div style="background: ${statusBg}; color: white; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <strong>${statusText}</strong>
                            <span style="background: ${envColor}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">${environment.toUpperCase()}</span>
                            ${tagsHtml}
                            ${domainInfo}
                            ${successfulServers.map(s => `
                                <div style="margin-top: 8px;">
                                    <a href="${s.url}" target="_blank" style="color: white;">${s.url}</a>
                                    <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none; margin-left: 8px;" 
                                            onclick="viewContainerLogs('${s.ip}', '${result.container_name}')">üìã Logs</button>
                                </div>
                            `).join('')}
                            ${failedServers.length > 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3);">
                                    <strong style="color: #fef3c7;">Failed servers:</strong>
                                    ${failedServers.map(s => `
                                        <div style="margin-top: 4px; color: #fef3c7;">
                                            ‚ùå ${s.ip}: ${s.error || 'Unknown error'}
                                            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none; margin-left: 8px;" 
                                                    onclick="viewContainerLogs('${s.ip}', '${result.container_name}')">üìã Logs</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    throw new Error(result?.error || 'Deployment failed');
                }
                
                // Refresh servers list
                loadServers();
                
                // Reset "new servers" to 0 to prevent accidental re-provisioning
                document.getElementById('deploy-additional-servers').value = '0';
                
                // Re-enable deploy button
                resetDeployButton();
                
            } catch (err) {
                log(`\n‚ùå Error: ${err.message}`);
                
                // Try to get server info for logs button
                // Construct container name from form values (same pattern as backend)
                const serverIps = getSelectedServers().map(s => s.ip);
                const workspace = 'fc153d'; // TODO: get from auth
                const containerNameGuess = `${workspace}_${project || 'default'}_${environment}_${name}`.replace(/-/g, '_').toLowerCase();
                
                const logsButtons = serverIps.length > 0 ? `
                    <div style="margin-top: 8px; font-size: 0.9rem;">
                        View container logs: ${serverIps.map(ip => `
                            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none; margin-left: 4px;" 
                                    onclick="viewContainerLogs('${ip}', '${containerNameGuess}')">${ip}</button>
                        `).join('')}
                    </div>
                ` : '';
                
                document.getElementById('deploy-result').style.display = 'block';
                document.getElementById('deploy-result').innerHTML = `
                    <div style="background: var(--danger); color: white; padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <strong>‚ùå Deployment Failed</strong><br>
                        ${err.message}
                        ${logsButtons}
                    </div>
                `;
                // Reset "new servers" to 0 to prevent accidental re-provisioning
                document.getElementById('deploy-additional-servers').value = '0';
                resetDeployButton();
            }
        }
        
        // Helper to read file as base64
        async function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function waitForAgent(serverIp, log) {
            for (let i = 0; i < 60; i++) {
                try {
                    const healthResult = await api('GET', `/infra/agent/health?server_ip=${serverIp}`);
                    if (healthResult.status === 'healthy') {
                        return healthResult; // Return full result with version
                    }
                } catch (e) {}
                log(`   Waiting... (${(i+1)*5}s)`);
                await new Promise(r => setTimeout(r, 5000));
            }
            throw new Error('Node agent not responding');
        }
        
        async function viewContainerLogs(serverIp, containerName) {
            try {
                const result = await api('GET', `/infra/agent/${serverIp}/containers/${containerName}/logs?lines=200`);
                
                // Handle various response formats
                let logs = 'No logs available';
                if (typeof result === 'string') {
                    logs = result;
                } else if (result?.logs) {
                    logs = result.logs;
                } else if (result?.data?.logs) {
                    logs = result.data.logs;
                } else if (result) {
                    logs = JSON.stringify(result, null, 2);
                }
                
                // Remove existing log modals
                document.querySelectorAll('.log-modal-overlay').forEach(m => m.remove());
                
                // Show in modal
                const overlay = document.createElement('div');
                overlay.className = 'log-modal-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
                
                overlay.innerHTML = `
                    <div style="background: var(--bg-card); border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">üìã Container Logs: ${containerName} @ ${serverIp}</span>
                            <button class="btn btn-ghost btn-sm" onclick="this.closest('.log-modal-overlay').remove()">‚úï</button>
                        </div>
                        <div style="flex: 1; overflow: auto; padding: 0;">
                            <pre id="log-content" style="background: var(--bg-input); color: var(--text); padding: 16px; margin: 0; 
                                        min-height: 300px; max-height: 60vh; overflow: auto; font-size: 12px; white-space: pre-wrap; word-break: break-word;"></pre>
                        </div>
                        <div style="padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
                            <button class="btn btn-primary btn-sm" onclick="viewContainerLogs('${serverIp}', '${containerName}')">‚Üª Refresh</button>
                            <button class="btn btn-ghost btn-sm" onclick="this.closest('.log-modal-overlay').remove()">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                // Set content safely (avoid XSS)
                document.getElementById('log-content').textContent = logs;
                
            } catch (err) {
                showToast('Failed to fetch logs: ' + err.message, 'error');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function doBuild(serverIp, name, dockerfile, log) {
            // Build with proper error handling to show full logs
            const doToken = getLocalDoToken();
            const url = `${API_BASE}/infra/agent/${serverIp}/build?do_token=${encodeURIComponent(doToken)}`;
            
            let res, result;
            try {
                res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({
                        context_path: '/app/',
                        image_tag: `${name}:latest`,
                        dockerfile: dockerfile
                    })
                });
                
                result = await res.json();
            } catch (e) {
                log('‚ùå Network error: ' + e.message);
                throw new Error('Network error during build: ' + e.message);
            }
            
            // Handle wrapped response from API proxy: { success, data: { status, ... } }
            const buildData = result.data || result;
            
            if (!res.ok || buildData.status !== 'built') {
                log('');
                log('‚îÅ‚îÅ‚îÅ Build Failed ‚îÅ‚îÅ‚îÅ');
                
                if (buildData.error) {
                    log('');
                    log('Error output:');
                    const errorLines = buildData.error.split('\n');
                    for (const line of errorLines) {
                        log(line);
                    }
                }
                
                if (buildData.output && buildData.output.trim()) {
                    log('');
                    log('Build output:');
                    const outputLines = buildData.output.split('\n');
                    for (const line of outputLines) {
                        log(line);
                    }
                }
                
                if (!buildData.error && !buildData.output) {
                    log('No build output returned. Raw response:');
                    log(JSON.stringify(result, null, 2));
                }
                
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                throw new Error('Docker build failed - see logs above');
            }
            
            return buildData;
        }
        
        async function runContainer(serverIp, name, image, port, envVars, log) {
            log('üê≥ Starting container...');
            
            // Stop old container if exists
            try { await api('POST', `/infra/agent/${serverIp}/containers/${name}/stop`); } catch(e) {}
            try { await api('POST', `/infra/agent/${serverIp}/containers/${name}/remove`); } catch(e) {}
            
            const runResult = await api('POST', `/infra/agent/${serverIp}/containers/run`, {
                image: image,
                name: name,
                ports: { [port]: port },
                env_vars: envVars,
                restart_policy: 'unless-stopped',
            });
            
            if (runResult.status !== 'started') throw new Error(runResult.error || 'Failed to start');
            log('‚úÖ Container running');
        }
        
        // =============================================================================
        // Infrastructure
        // =============================================================================
        
        async function loadServers() {
            const listEl = document.getElementById('server-list');
            
            if (!hasDoToken()) {
                listEl.innerHTML = '<div class="empty-state"><p>Configure DO token in Settings first</p></div>';
                return;
            }
            
            listEl.innerHTML = '<div class="empty-state">Loading...</div>';
            
            try {
                // Get project filter
                const projectFilter = document.getElementById('server-project-filter')?.value || '';
                const params = projectFilter ? `?project=${encodeURIComponent(projectFilter)}` : '';
                
                const result = await api('GET', `/infra/servers${params}`);
                state.servers = result.servers || [];
                // Also update infra servers for deploy filtering (includes image info now)
                state.infraServers = state.servers.filter(s => s.status === 'active');
                
                try {
                    const vpcResult = await api('GET', '/infra/vpcs');
                    state.vpcs = (vpcResult.vpcs || []).reduce((m, v) => { m[v.id] = v.name; return m; }, {});
                } catch (e) {}
                
                renderServers();
                updateStatus();
                renderServerList();  // Update deploy form server list
            } catch (err) {
                listEl.innerHTML = `<div class="empty-state" style="color: var(--danger);">${err.message}</div>`;
            }
        }
        
        function renderServers() {
            const listEl = document.getElementById('server-list');
            
            if (state.servers.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>No servers yet</p></div>';
                return;
            }
            
            listEl.innerHTML = state.servers.map(s => {
                const statusClass = s.status === 'active' ? 'success' : s.status === 'new' ? 'warning' : 'danger';
                const vpcName = s.vpc_uuid ? state.vpcs[s.vpc_uuid] : null;
                
                return `
                    <div class="server-item">
                        <div class="server-header">
                            <span class="server-name">${s.name}</span>
                            <span class="badge badge-${statusClass}">${s.status}</span>
                            ${s.project ? `<span class="badge" style="background: rgba(99,102,241,0.2); color: #6366f1;">üìÅ ${s.project}</span>` : ''}
                            ${s.environment ? `<span class="badge" style="background: rgba(234,179,8,0.2); color: #ca8a04;">${s.environment}</span>` : ''}
                        </div>
                        <div class="server-details">
                            <span class="server-ip">${s.ip || 'No IP'}</span>
                            ${s.private_ip ? `<span class="server-ip" style="background: rgba(34,197,94,0.1);">üîí ${s.private_ip}</span>` : ''}
                            <span>${s.region}</span>
                            <span>${s.size}</span>
                            ${vpcName ? `<span class="badge badge-info">VPC: ${vpcName}</span>` : ''}
                        </div>
                        <div style="margin-top: 12px;">
                            <button class="btn btn-ghost btn-sm" onclick="checkServerHealth('${s.ip}', '${s.name}')" ${s.status !== 'active' ? 'disabled' : ''}>ü©∫ Health</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteServer(${s.id}, '${s.name}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function hasDoToken() {
            return !!getLocalDoToken();
        }
        
        async function checkServerHealth(ip, name) {
            // Show modal with health check result
            const overlay = document.createElement('div');
            overlay.className = 'log-modal-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            
            overlay.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">ü©∫ Health Check: ${name}</span>
                        <button onclick="this.closest('.log-modal-overlay').remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted);">√ó</button>
                    </div>
                    <div id="health-result" style="padding: 20px; font-family: monospace; font-size: 0.85rem;">
                        <p>‚è≥ Checking ${ip}:9999...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            const resultEl = document.getElementById('health-result');
            
            try {
                const result = await api('GET', `/infra/agent/health?server_ip=${ip}`);
                
                // Agent returns status: 'healthy' (docker ok), 'degraded' (docker down), or 'unhealthy'
                const isHealthy = result.status === 'healthy';
                const isDegraded = result.status === 'degraded';
                
                if (isHealthy || isDegraded) {
                    const statusColor = isHealthy ? 'var(--success)' : 'var(--warning)';
                    const statusIcon = isHealthy ? '‚úÖ' : '‚ö†Ô∏è';
                    const statusText = isHealthy ? 'Agent Healthy' : 'Agent Degraded (Docker down)';
                    
                    resultEl.innerHTML = `
                        <div style="color: ${statusColor}; margin-bottom: 16px; font-size: 1.1rem;">${statusIcon} ${statusText}</div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr><td style="padding: 4px 8px; color: var(--text-muted);">Version</td><td style="padding: 4px 8px;">${result.version || '?'}</td></tr>
                            <tr><td style="padding: 4px 8px; color: var(--text-muted);">Docker</td><td style="padding: 4px 8px;">${result.docker_running ? '‚úÖ Running' : '‚ùå Not running'}</td></tr>
                            <tr><td style="padding: 4px 8px; color: var(--text-muted);">Containers</td><td style="padding: 4px 8px;">${Array.isArray(result.containers) ? result.containers.length : (result.containers ?? '?')}</td></tr>
                        </table>
                        ${!result.docker_running ? `
                        <div style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">
                            <strong>‚ö†Ô∏è Docker not running</strong>
                            <p style="margin: 8px 0 0 0; font-size: 0.8rem;">This usually means the snapshot needs to be recreated. Delete the base snapshot, then Initialize Environment again.</p>
                        </div>
                        ` : ''}
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div style="color: var(--danger); margin-bottom: 16px; font-size: 1.1rem;">‚ùå Agent Unhealthy</div>
                        <pre style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (err) {
                resultEl.innerHTML = `
                    <div style="color: var(--danger); margin-bottom: 16px; font-size: 1.1rem;">‚ùå Failed to reach agent</div>
                    <p style="margin-bottom: 12px;">${err.message}</p>
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; font-size: 0.8rem;">
                        <p style="margin-bottom: 8px;"><strong>Debug:</strong></p>
                        <p>‚Ä¢ Server IP: ${ip}</p>
                        <p>‚Ä¢ Agent port: 9999</p>
                        <p>‚Ä¢ DO Token (first 8): ${getLocalDoToken().slice(0,8)}...</p>
                        <p style="margin-top: 12px;"><strong>Try from PowerShell:</strong></p>
                        <code style="display: block; margin-top: 4px; word-break: break-all;">curl.exe -H "X-API-Key: YOUR_KEY" http://${ip}:9999/ping</code>
                    </div>
                `;
            }
        }
        
        function updateStatus() {
            const activeCount = state.servers.filter(s => s.status === 'active').length;
            const hasDo = hasDoToken();
            
            document.getElementById('status-info').innerHTML = `
                <div>Servers: <strong>${state.servers.length}</strong> (${activeCount} active)</div>
                <div>Snapshots: <strong>${state.snapshots.length}</strong></div>
                <div>DO Token: <strong style="color: ${hasDo ? 'var(--success)' : 'var(--warning)'};">
                    ${hasDo ? '‚úì Configured' : '‚ö† Not set'}
                </strong></div>
            `;
        }
        
        async function deleteServer(id, name) {
            if (!confirm(`Delete "${name}"?`)) return;
            try {
                await api('DELETE', `/infra/servers/${id}`);
                showToast('Server deleted', 'success');
                loadServers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
        
        // =============================================================================
        // Provision Modal
        // =============================================================================
        
        function showProvisionModal() {
            // Check if we have any snapshots
            if (state.snapshots.length === 0) {
                showModal('‚ö†Ô∏è No Snapshots', `
                    <div style="text-align: center; padding: 20px;">
                        <p style="margin-bottom: 16px;">You need a snapshot to create servers.</p>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            Snapshots are pre-configured images with Docker and tools installed.
                        </p>
                        <button class="btn btn-primary" onclick="closeModal(); showTab('snapshots');">
                            Go to Snapshots
                        </button>
                    </div>
                `);
                return;
            }
            
            const snapshotOptions = state.snapshots.map(s => 
                `<option value="${s.id}" data-regions='${JSON.stringify(s.regions || [])}'>${s.name} (${s.size_gigabytes}GB)</option>`
            ).join('');
            
            showModal('üöÄ Provision Server', `
                <form onsubmit="provisionServer(event)">
                    <div class="form-group">
                        <label>Snapshot *</label>
                        <select id="prov-snapshot" required onchange="updateRegionOptions()">
                            <option value="">Select a snapshot...</option>
                            ${snapshotOptions}
                        </select>
                        <small style="color: var(--text-muted);">Servers are created from snapshots with Docker pre-installed</small>
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Name (optional)</label>
                            <input type="text" id="prov-name" placeholder="Auto-generated if empty">
                        </div>
                        <div class="form-group">
                            <label>Project</label>
                            <input type="text" id="prov-project" placeholder="my-project" pattern="[a-z0-9-]*">
                        </div>
                        <div class="form-group">
                            <label>Environment</label>
                            <select id="prov-environment">
                                <option value="dev">dev</option>
                                <option value="staging">staging</option>
                                <option value="prod" selected>prod</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Region</label>
                            <select id="prov-region">
                                <option value="">Select snapshot first...</option>
                            </select>
                            <small id="region-hint" style="color: var(--text-muted);"></small>
                        </div>
                        <div class="form-group">
                            <label>Size</label>
                            <select id="prov-size">
                                <option value="s-1vcpu-1gb">1 vCPU / 1GB ($6/mo)</option>
                                <option value="s-1vcpu-2gb">1 vCPU / 2GB ($12/mo)</option>
                                <option value="s-2vcpu-2gb">2 vCPU / 2GB ($18/mo)</option>
                                <option value="s-2vcpu-4gb">2 vCPU / 4GB ($24/mo)</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">Create</button>
                    </div>
                </form>
            `);
        }
        
        function updateRegionOptions() {
            const select = document.getElementById('prov-snapshot');
            const regionSelect = document.getElementById('prov-region');
            const hint = document.getElementById('region-hint');
            const option = select.options[select.selectedIndex];
            
            if (!option || !option.value) {
                regionSelect.innerHTML = '<option value="">Select snapshot first...</option>';
                hint.textContent = '';
                return;
            }
            
            const regions = JSON.parse(option.dataset.regions || '[]');
            
            const regionNames = {
                'lon1': 'London', 'ams3': 'Amsterdam', 'fra1': 'Frankfurt',
                'nyc1': 'New York 1', 'nyc3': 'New York 3', 'sfo2': 'San Francisco 2', 
                'sfo3': 'San Francisco 3', 'tor1': 'Toronto',
                'sgp1': 'Singapore', 'blr1': 'Bangalore', 'syd1': 'Sydney'
            };
            
            if (regions.length === 0) {
                regionSelect.innerHTML = '<option value="lon1">London (default)</option>';
                hint.textContent = 'No region info available';
            } else {
                regionSelect.innerHTML = regions.map(r => 
                    `<option value="${r}">${regionNames[r] || r}</option>`
                ).join('');
                hint.textContent = `Available in ${regions.length} region(s)`;
            }
        }
        
        async function provisionServer(e) {
            e.preventDefault();
            const name = document.getElementById('prov-name').value.trim();
            const project = document.getElementById('prov-project').value.trim();
            const environment = document.getElementById('prov-environment').value;
            const region = document.getElementById('prov-region').value;
            const size = document.getElementById('prov-size').value;
            const snapshotId = document.getElementById('prov-snapshot').value;
            
            if (!snapshotId) {
                showToast('Please select a snapshot', 'error');
                return;
            }
            
            if (!region) {
                showToast('Please select a region', 'error');
                return;
            }
            
            closeModal();
            showToast('Creating server...', 'info');
            
            try {
                const result = await api('POST', '/infra/servers/provision', {
                    name: name || undefined,
                    project: project || undefined,
                    environment,
                    region,
                    size,
                    snapshot_id: snapshotId,
                });
                showToast(`Server "${result.server?.name || 'Server'}" created!`, 'success');
                loadServers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
        
        // =============================================================================
        // Snapshots
        // =============================================================================
        
        async function loadSnapshots() {
            const listEl = document.getElementById('snapshot-list');
            
            if (!hasDoToken()) {
                listEl.innerHTML = '<div class="empty-state"><p>Configure DO token in Settings first</p></div>';
                return;
            }
            
            listEl.innerHTML = '<div class="empty-state">Loading...</div>';
            
            try {
                const result = await api('GET', '/infra/snapshots');
                state.snapshots = result.snapshots || [];
                renderSnapshots();
                checkBaseSnapshot();
                checkRegistry();
                updateStatus();
            } catch (err) {
                listEl.innerHTML = `<div class="empty-state" style="color: var(--danger);">${err.message}</div>`;
            }
        }
        
        async function checkRegistry() {
            const statusEl = document.getElementById('registry-status');
            if (!hasDoToken()) {
                statusEl.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">Configure DO token first</p>';
                return;
            }
            
            try {
                const result = await api('GET', '/infra/registry');
                if (result.exists) {
                    statusEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="badge badge-success">‚úì Ready</span>
                            <span style="font-size: 0.8rem;">500MB free</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            For small app images from CI
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <p style="color: var(--text-muted); margin-bottom: 8px; font-size: 0.85rem;">
                            Optional: For pushing app images
                        </p>
                        <button class="btn btn-ghost btn-sm" onclick="createRegistry()">Create Registry</button>
                    `;
                }
            } catch (e) {
                statusEl.innerHTML = `
                    <p style="color: var(--text-muted); font-size: 0.85rem;">
                        Optional: For app images
                    </p>
                    <button class="btn btn-ghost btn-sm" onclick="createRegistry()">Create Registry</button>
                `;
            }
        }
        
        function renderSnapshots() {
            const listEl = document.getElementById('snapshot-list');
            
            // Store for reference by details panel
            window.currentSnapshots = state.snapshots;
            
            if (state.snapshots.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>No snapshots yet</p><p style="font-size: 0.8rem; color: var(--text-muted);">Create a base snapshot first in Settings</p></div>';
                return;
            }
            
            listEl.innerHTML = state.snapshots.map(s => {
                const regionCount = (s.regions || []).length;
                const isBase = s.name.startsWith('base-');
                const allRegions = regionCount >= 14;  // DO has ~14 regions
                const hasActiveTransfer = activeTransfers[s.id] && Object.values(activeTransfers[s.id].regionStatus).some(st => st === 'in-progress');
                return `
                    <div class="server-item" style="cursor: pointer;" onclick="showSnapshotDetails('${s.id}')">
                        <div class="server-header">
                            <span class="server-name">${isBase ? 'üèóÔ∏è' : 'üì∏'} ${s.name}</span>
                            <span class="badge badge-info">${s.size_gigabytes} GB</span>
                            ${hasActiveTransfer ? '<span class="badge badge-warning">‚è≥ Transferring</span>' : ''}
                        </div>
                        <div class="server-details">
                            <span>üåç ${regionCount} region${regionCount !== 1 ? 's' : ''}</span>
                            <span>ID: ${s.id}</span>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;" onclick="event.stopPropagation()">
                            ${!allRegions ? `<button class="btn btn-primary btn-sm" onclick="transferSnapshot('${s.id}')">üåê All Regions</button>` : '<span class="badge badge-success">‚úì All Regions</span>'}
                            <button class="btn btn-danger btn-sm" onclick="deleteSnapshot('${s.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function checkBaseSnapshot() {
            const statusEl = document.getElementById('base-snapshot-status');
            if (!hasDoToken()) {
                statusEl.innerHTML = '<p style="color: var(--warning);">‚ö†Ô∏è Configure DO token in Settings first</p>';
                return;
            }
            
            try {
                const status = await api('GET', '/infra/setup/status');
                if (status.ready) {
                    const snap = status.snapshot;
                    statusEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span class="badge badge-success">‚úì Ready</span>
                            <span>${snap.name}</span>
                            <span class="badge badge-info" style="margin-left: auto;">Agent v${EXPECTED_AGENT_VERSION}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                            Available in ${snap.regions?.length || 0} region(s)
                            ${snap.all_regions ? ' (all regions)' : ''}
                        </div>
                        <div style="background: var(--bg-input); border-radius: 8px; padding: 12px; font-size: 0.8rem;">
                            <strong style="color: var(--text);">Pre-pulled images:</strong>
                            <div style="margin-top: 8px; color: var(--text-muted);">
                                nginx, postgres:16, redis:7, opensearch:2, qdrant, python:3.11-slim, node:20-alpine
                            </div>
                            <div style="margin-top: 8px; color: var(--text-muted);">
                                <strong>System:</strong> Docker, htop, curl, git, jq, vim
                            </div>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            No base snapshot found. Create one to enable quick server provisioning.
                        </p>
                        <button class="btn btn-primary" onclick="createBaseSnapshot()">
                            üöÄ Create base snapshot
                        </button>
                        <div style="margin-top: 16px; background: var(--bg-input); border-radius: 8px; padding: 12px; font-size: 0.8rem;">
                            <strong>base snapshot includes:</strong>
                            <ul style="margin: 8px 0 0 16px; color: var(--text-muted);">
                                <li>Docker + docker-compose</li>
                                <li>Pre-pulled: nginx, postgres:16, redis:7, opensearch:2, qdrant, python:3.11-slim, node:20-alpine</li>
                                <li>Tools: htop, curl, git, jq, vim</li>
                                <li>Node agent for deployments</li>
                            </ul>
                        </div>
                    `;
                }
            } catch (err) {
                statusEl.innerHTML = `
                    <p style="color: var(--text-muted); margin-bottom: 16px;">
                        Create a base snapshot to enable quick server provisioning.
                    </p>
                    <button class="btn btn-primary" onclick="createBaseSnapshot()">
                        üöÄ Create base snapshot
                    </button>
                `;
            }
        }
        
        async function createBaseSnapshot() {
            showSnapshotLog();
            
            const doToken = getLocalDoToken();
            if (!doToken) {
                showToast('Configure DO token first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/infra/setup/init/stream?do_token=${encodeURIComponent(doToken)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                    },
                });
                
                await handleSnapshotStream(response);
                checkBaseSnapshot();
            } catch (err) {
                appendLog('Error: ' + err.message, 'error');
            }
        }
        
        async function handleSnapshotStream(response) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const text = decoder.decode(value);
                const lines = text.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const event = JSON.parse(line.slice(6));
                            
                            if (event.type === 'log') {
                                const type = event.message.includes('‚úÖ') ? 'success' : 
                                             event.message.includes('‚ùå') ? 'error' :
                                             event.message.includes('‚ö†') ? 'warning' : 'info';
                                appendLog(event.message, type);
                            }
                            
                            if (event.type === 'progress') {
                                if (event.percent) {
                                    document.getElementById('snapshot-progress').style.width = event.percent + '%';
                                } else if (event.step && event.total) {
                                    setProgress(event.step, event.total);
                                }
                            }
                            
                            if (event.type === 'done' || event.type === 'complete') {
                                // Handle both flat format and nested data format
                                const success = event.data?.success ?? event.success;
                                const error = event.data?.error ?? event.error;
                                
                                if (success !== false) {
                                    showToast('Snapshot created!', 'success');
                                    loadSnapshots();
                                    checkBaseSnapshot();
                                    // Note: Backend already transfers to all regions automatically
                                } else {
                                    showToast('Failed: ' + (error || 'Unknown error'), 'error');
                                }
                            }
                            
                            if (event.type === 'error') {
                                appendLog(event.message, 'error');
                            }
                        } catch (e) {}
                    }
                }
            }
        }
        
        // Snapshot log helpers
        function showSnapshotLog() {
            document.getElementById('snapshot-log-card').classList.remove('hidden');
            document.getElementById('snapshot-log').innerHTML = '';
            document.getElementById('snapshot-progress').style.width = '0%';
        }
        
        function hideSnapshotLog() {
            document.getElementById('snapshot-log-card').classList.add('hidden');
        }
        
        function appendLog(message, type = '') {
            const logEl = document.getElementById('snapshot-log');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            line.innerHTML = `<span style="color: var(--text-muted); font-size: 0.85em;">[${time}]</span> ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function setProgress(step, total) {
            const pct = Math.round((step / total) * 100);
            document.getElementById('snapshot-progress').style.width = `${pct}%`;
        }
        
        // Region code to city name mapping (only add number if multiple datacenters)
        const REGION_NAMES = {
            'nyc1': 'New York 1', 'nyc2': 'New York 2', 'nyc3': 'New York 3',
            'sfo1': 'San Francisco 1', 'sfo2': 'San Francisco 2', 'sfo3': 'San Francisco 3',
            'ams2': 'Amsterdam 2', 'ams3': 'Amsterdam 3',
            'sgp1': 'Singapore',
            'lon1': 'London',
            'fra1': 'Frankfurt',
            'tor1': 'Toronto',
            'blr1': 'Bangalore',
            'syd1': 'Sydney',
        };
        
        function getRegionName(slug) {
            return REGION_NAMES[slug] || slug;
        }
        
        // Track active transfers per snapshot
        const activeTransfers = {};
        
        async function transferSnapshot(id) {
            showToast('Starting transfer to all regions...', 'info');
            try {
                const result = await api('POST', `/infra/snapshots/${id}/transfer-all`);
                
                if (result.transferring_to && result.transferring_to.length > 0) {
                    // Store transfer state
                    activeTransfers[id] = {
                        snapshotName: result.snapshot_name,
                        regionStatus: {},
                        actionMap: {},
                    };
                    result.already_available_in.forEach(r => activeTransfers[id].regionStatus[r] = 'complete');
                    result.actions.forEach(a => {
                        activeTransfers[id].regionStatus[a.region] = a.status === 'completed' ? 'complete' : 
                                             a.status === 'failed' ? 'failed' : 'in-progress';
                        activeTransfers[id].actionMap[a.region] = a.action_id;
                    });
                    
                    // Show details panel and start polling
                    showSnapshotDetails(id);
                    startTransferPolling(id);
                } else {
                    showToast('Already available in all regions!', 'success');
                    loadSnapshots();
                }
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
        
        function showSnapshotDetails(snapshotId) {
            const detailsEl = document.getElementById('snapshot-details');
            const transfer = activeTransfers[snapshotId];
            
            // Find snapshot in current data
            const snapshot = window.currentSnapshots?.find(s => String(s.id) === String(snapshotId));
            
            if (!snapshot && !transfer) {
                detailsEl.innerHTML = '';
                detailsEl.style.display = 'none';
                return;
            }
            
            const name = transfer?.snapshotName || snapshot?.name || snapshotId;
            const regions = transfer?.regionStatus || {};
            const snapshotRegions = snapshot?.regions || [];
            
            // Merge snapshot regions with transfer status
            snapshotRegions.forEach(r => {
                if (!regions[r]) regions[r] = 'complete';
            });
            
            const allRegions = Object.keys(REGION_NAMES).sort();
            const hasTransfer = transfer && Object.values(transfer.regionStatus).some(s => s === 'in-progress');
            
            detailsEl.innerHTML = `
                <div class="card" style="margin-top: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">üì∏ ${name}</h3>
                        <button class="btn btn-sm" onclick="hideSnapshotDetails()">‚úï</button>
                    </div>
                    ${hasTransfer ? '<p style="color: var(--warning); font-size: 0.85rem; margin-bottom: 12px;">‚è≥ Transfer in progress...</p>' : ''}
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                        ${allRegions.map(r => {
                            const status = regions[r] || 'unavailable';
                            const icon = status === 'complete' ? '‚úÖ' : 
                                         status === 'failed' ? '‚ùå' : 
                                         status === 'in-progress' ? '‚è≥' : '‚óã';
                            const color = status === 'complete' ? 'var(--success)' : 
                                          status === 'failed' ? 'var(--danger)' : 
                                          status === 'in-progress' ? 'var(--warning)' : 'var(--text-muted)';
                            return `<div style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-input); border-radius: 4px;">
                                <span>${icon}</span>
                                <span style="color: ${color}; font-size: 0.85rem;">${getRegionName(r)}</span>
                            </div>`;
                        }).join('')}
                    </div>
                    <div id="transfer-status-${snapshotId}" style="margin-top: 12px; font-size: 0.85rem; color: var(--text-muted);">
                        ${Object.values(regions).filter(s => s === 'complete').length}/${allRegions.length} regions available
                    </div>
                </div>
            `;
            detailsEl.style.display = 'block';
            window.currentSnapshotDetailsId = snapshotId;
        }
        
        function hideSnapshotDetails() {
            document.getElementById('snapshot-details').style.display = 'none';
            window.currentSnapshotDetailsId = null;
        }
        
        function startTransferPolling(snapshotId) {
            // Clear any existing poll for this snapshot
            if (window.transferPolls?.[snapshotId]) {
                clearInterval(window.transferPolls[snapshotId]);
            }
            window.transferPolls = window.transferPolls || {};
            
            let pollCount = 0;
            const maxPolls = 120; // 10 minutes at 5s intervals
            
            window.transferPolls[snapshotId] = setInterval(async () => {
                pollCount++;
                const transfer = activeTransfers[snapshotId];
                if (!transfer || pollCount > maxPolls) {
                    clearInterval(window.transferPolls[snapshotId]);
                    return;
                }
                
                try {
                    let allDone = true;
                    for (const region of Object.keys(transfer.regionStatus)) {
                        if (transfer.regionStatus[region] === 'complete' || transfer.regionStatus[region] === 'failed') continue;
                        
                        allDone = false;
                        const actionId = transfer.actionMap[region];
                        if (actionId) {
                            try {
                                const actionResult = await api('GET', `/infra/actions/${actionId}`);
                                if (actionResult.status === 'completed') {
                                    transfer.regionStatus[region] = 'complete';
                                } else if (actionResult.status === 'errored') {
                                    transfer.regionStatus[region] = 'failed';
                                }
                            } catch (e) { /* ignore */ }
                        }
                    }
                    
                    // Update UI if this snapshot is currently shown
                    if (window.currentSnapshotDetailsId === snapshotId) {
                        showSnapshotDetails(snapshotId);
                    }
                    
                    if (allDone) {
                        clearInterval(window.transferPolls[snapshotId]);
                        delete activeTransfers[snapshotId];
                        loadSnapshots();
                    }
                } catch (e) {
                    clearInterval(window.transferPolls[snapshotId]);
                }
            }, 5000);
        }
        
        async function deleteSnapshot(id) {
            if (!confirm('Delete this snapshot?')) return;
            try {
                await api('DELETE', `/infra/snapshots/${id}`);
                showToast('Deleted', 'success');
                loadSnapshots();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
        
        // =============================================================================
        // Images (base snapshot Builder)
        // =============================================================================
        
        async function createRegistry() {
            const statusEl = document.getElementById('registry-status');
            statusEl.innerHTML = '<p style="color: var(--text-muted);">Creating registry...</p>';
            
            try {
                const result = await api('POST', '/infra/registry');
                showToast('Registry created!', 'success');
                statusEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span class="badge badge-success">‚úì Ready</span>
                        <span style="font-size: 0.8rem;">500MB free</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                        For small app images. Push from CI/local.
                    </div>
                `;
            } catch (err) {
                showToast(err.message, 'error');
                statusEl.innerHTML = `
                    <p style="color: var(--danger);">Failed: ${err.message}</p>
                    <button class="btn btn-ghost btn-sm" onclick="createRegistry()">Retry</button>
                `;
            }
        }
        
        function showBuildSnapshotModal() {
            // Check if base snapshot exists first
            api('GET', '/infra/setup/status').then(status => {
                if (!status.ready) {
                    showModal('‚ö†Ô∏è Base Snapshot Required', `
                        <p style="margin-bottom: 16px;">
                            You need to create a base snapshot first. Custom snapshots are built ON TOP of the base
                            (so they inherit Docker, node agent, and pre-pulled images).
                        </p>
                        <div style="display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="closeModal(); createBaseSnapshot();">Create Base Now</button>
                        </div>
                    `);
                    return;
                }
                
                showBuildSnapshotModalReal();
            }).catch(err => {
                console.error('Setup status check failed:', err);
                showBuildSnapshotModalReal();
            });
        }
        
        function showBuildSnapshotModalReal() {
            showModal('üîß Build Custom Snapshot', `
                <form onsubmit="buildSnapshot(event)">
                    <div style="background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.8rem;">
                        <strong>üí° What this does:</strong><br>
                        <span style="color: var(--text-muted);">
                            Builds a Docker image with your packages, bakes it into a snapshot.
                            Your app Dockerfile uses <code>FROM local/base:latest</code> - pick snapshot at deploy time.
                        </span>
                    </div>
                    
                    <div class="form-group">
                        <label>Snapshot Name *</label>
                        <input type="text" id="build-name" placeholder="ocr-ready" required pattern="[a-z0-9-]+" title="Lowercase letters, numbers, hyphens only">
                    </div>
                    
                    <div class="form-group">
                        <label>Base Template *</label>
                        <select id="build-template" required onchange="updateBuildTemplateFields()">
                            <option value="python">Python 3.11</option>
                            <option value="node">Node.js 20</option>
                            <option value="python-node">Python + Node.js</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>APT Packages (Ubuntu)</label>
                        <textarea id="build-apt" rows="2" placeholder="tesseract-ocr&#10;ffmpeg&#10;imagemagick"></textarea>
                        <small style="color: var(--text-muted);">One per line</small>
                    </div>
                    
                    <div id="build-pip-field" class="form-group">
                        <label>Pip Packages</label>
                        <textarea id="build-pip" rows="2" placeholder="opencv-python&#10;pytesseract&#10;torch"></textarea>
                        <small style="color: var(--text-muted);">One per line</small>
                    </div>
                    
                    <div id="build-npm-field" class="form-group hidden">
                        <label>NPM Packages (Global)</label>
                        <textarea id="build-npm" rows="2" placeholder="typescript&#10;pm2"></textarea>
                        <small style="color: var(--text-muted);">One per line</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Docker Images to Pre-pull</label>
                        <textarea id="build-extra" rows="2" placeholder="mysql:8&#10;mongo:6"></textarea>
                        <small style="color: var(--text-muted);">One per line (optional)</small>
                    </div>
                    
                    <p style="color: var(--warning); font-size: 0.85rem; margin-bottom: 16px;">
                        ‚ö†Ô∏è Takes 10-25 minutes. Builds on a temp server then snapshots it.
                    </p>
                    
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">Build Snapshot</button>
                    </div>
                </form>
            `);
            updateBuildTemplateFields();
        }
        
        function updateBuildTemplateFields() {
            const template = document.getElementById('build-template').value;
            const pipField = document.getElementById('build-pip-field');
            const npmField = document.getElementById('build-npm-field');
            
            pipField.classList.toggle('hidden', template === 'node');
            npmField.classList.toggle('hidden', template === 'python');
        }
        
        async function buildSnapshot(e) {
            e.preventDefault();
            
            const name = document.getElementById('build-name').value.trim();
            const template = document.getElementById('build-template').value;
            const aptPackages = document.getElementById('build-apt').value.split('\n').map(s => s.trim()).filter(Boolean);
            const pipPackages = document.getElementById('build-pip').value.split('\n').map(s => s.trim()).filter(Boolean);
            const npmPackages = document.getElementById('build-npm').value.split('\n').map(s => s.trim()).filter(Boolean);
            const extraImages = document.getElementById('build-extra').value.split('\n').map(s => s.trim()).filter(Boolean);
            
            closeModal();
            showSnapshotLog();
            
            const doToken = getLocalDoToken();
            
            try {
                const response = await fetch(`${API_BASE}/infra/images/build/stream?do_token=${encodeURIComponent(doToken)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        image_tag: 'base',
                        template,
                        apt_packages: aptPackages,
                        pip_packages: pipPackages,
                        npm_packages: npmPackages,
                        extra_docker_images: extraImages,
                    }),
                });
                
                await handleSnapshotStream(response);
            } catch (err) {
                appendLog('Error: ' + err.message, 'error');
            }
        }
        
        // =============================================================================
        // Settings
        // =============================================================================
        
        function checkDOToken() {
            updateTokenStatus();
            updateStatus();
        }
        
        function updateTokenStatus() {
            const statusEl = document.getElementById('token-status');
            const localToken = getLocalDoToken();
            
            statusEl.innerHTML = localToken 
                ? `<span class="badge badge-success">‚úì Token configured</span> <span style="font-size: 0.8rem; color: var(--text-muted);">(${localToken.substring(0, 12)}...)</span>`
                : '<span class="badge badge-warning">‚ö† No token set</span>';
        }
        
        async function saveDOToken(e) {
            e.preventDefault();
            const token = document.getElementById('do-token').value.trim();
            if (!token) { showToast('Enter a token', 'error'); return; }
            
            setCookie('do_token_local', token, 30);  // 30 days
            document.getElementById('do-token').value = '';
            showToast('Token saved', 'success');
            checkDOToken();
            loadServers();
            loadSnapshots();
            
            // Auto-check and create base snapshot if needed
            setTimeout(async () => {
                try {
                    const status = await api('GET', '/infra/setup/status');
                    if (!status.ready) {
                        showToast('Creating base snapshot automatically...', 'info');
                        await createBaseSnapshot();
                    }
                } catch (e) {
                    // No snapshot exists, create one
                    showToast('Creating base snapshot automatically...', 'info');
                    await createBaseSnapshot();
                }
            }, 500);
        }
        
        async function testDOToken() {
            let token = document.getElementById('do-token').value.trim() || getLocalDoToken();
            if (!token) { showToast('Enter or save a token first', 'error'); return; }
            
            try {
                const result = await api('POST', '/infra/test/do-token', { token }, { skipDoToken: true });
                showToast(result.valid ? `Valid! ${result.email}` : 'Invalid token', result.valid ? 'success' : 'error');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
        
        async function deleteDOToken() {
            if (!confirm('Clear token?')) return;
            deleteCookie('do_token_local');
            showToast('Token cleared', 'success');
            checkDOToken();
        }
        
        async function showAgentKey() {
            const doToken = getLocalDoToken();
            if (!doToken) {
                showToast('Save DO token first', 'error');
                return;
            }
            
            try {
                const result = await api('GET', '/infra/credentials');
                document.getElementById('agent-key-value').textContent = result.agent_key || 'Error getting key';
                document.getElementById('agent-key-display').style.display = 'block';
            } catch (err) {
                showToast('Failed to get agent key: ' + err.message, 'error');
            }
        }
        
        // =============================================================================
        // Cloudflare Functions
        // =============================================================================
        
        function getCFToken() {
            return getCookie('cf_token');
        }
        
        function saveCFToken(e) {
            e.preventDefault();
            const token = document.getElementById('cf-token').value.trim();
            if (!token) {
                showToast('Enter a token', 'error');
                return;
            }
            setCookie('cf_token', token, 30);
            showToast('Cloudflare token saved', 'success');
            document.getElementById('cf-token').value = '';
            checkCFToken();
        }
        
        async function testCFToken() {
            const token = getCFToken();
            if (!token) {
                showToast('Save Cloudflare token first', 'error');
                return;
            }
            
            const status = document.getElementById('cf-token-status');
            status.innerHTML = '<span style="color: var(--text-muted);">Testing...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/cloudflare/zones?cloudflare_token=${encodeURIComponent(token)}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();
                
                if (data.success && data.zones) {
                    const zoneList = data.zones.map(z => `<li>${z.name} (${z.status})</li>`).join('');
                    status.innerHTML = `
                        <div style="color: var(--success); margin-bottom: 8px;">‚úÖ Token valid</div>
                        <div style="font-size: 0.85rem;">
                            <strong>Available zones:</strong>
                            <ul style="margin: 4px 0 0 16px;">${zoneList || '<li>No zones found</li>'}</ul>
                        </div>
                    `;
                } else {
                    status.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Invalid token'}</span>`;
                }
            } catch (err) {
                status.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        function deleteCFToken() {
            if (!confirm('Clear Cloudflare token?')) return;
            deleteCookie('cf_token');
            showToast('Token cleared', 'success');
            checkCFToken();
        }
        
        function checkCFToken() {
            const token = getCFToken();
            const status = document.getElementById('cf-token-status');
            if (token) {
                status.innerHTML = '<span style="color: var(--success);">‚úì Token saved</span>';
            } else {
                status.innerHTML = '<span style="color: var(--text-muted);">No token saved</span>';
            }
        }
        
        async function setupDomain(e) {
            e.preventDefault();
            const token = getCFToken();
            if (!token) {
                showToast('Save Cloudflare token first', 'error');
                return;
            }
            
            const domain = document.getElementById('domain-name').value.trim();
            const ip = document.getElementById('domain-ip').value.trim();
            const proxied = document.getElementById('domain-proxied').checked;
            
            if (!domain || !ip) {
                showToast('Fill in domain and IP', 'error');
                return;
            }
            
            const result = document.getElementById('domain-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Setting up...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/cloudflare/domain`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        domain,
                        server_ip: ip,
                        cloudflare_token: token,
                        proxied,
                    }),
                });
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <div style="color: var(--success);">‚úÖ ${data.message}</div>
                        ${proxied ? '<div style="font-size: 0.85rem; margin-top: 8px;">HTTPS ready at <a href="https://' + domain + '" target="_blank">https://' + domain + '</a></div>' : ''}
                    `;
                    showToast('Domain configured', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        async function setupLoadBalancer(e) {
            e.preventDefault();
            const token = getCFToken();
            if (!token) {
                showToast('Save Cloudflare token first', 'error');
                return;
            }
            
            const domain = document.getElementById('lb-domain').value.trim();
            const ipsText = document.getElementById('lb-ips').value.trim();
            const proxied = document.getElementById('lb-proxied').checked;
            
            if (!domain || !ipsText) {
                showToast('Fill in domain and IPs', 'error');
                return;
            }
            
            const ips = ipsText.split(',').map(ip => ip.trim()).filter(ip => ip);
            if (ips.length < 1) {
                showToast('Enter at least one IP', 'error');
                return;
            }
            
            const result = document.getElementById('lb-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Setting up load balancing...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/cloudflare/lb`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        domain,
                        server_ips: ips,
                        cloudflare_token: token,
                        proxied,
                    }),
                });
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <div style="color: var(--success);">‚úÖ ${data.message}</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">
                            ${data.record_count} A record(s) created
                        </div>
                        ${proxied ? '<div style="margin-top: 8px;">HTTPS ready at <a href="https://' + domain + '" target="_blank">https://' + domain + '</a></div>' : ''}
                    `;
                    showToast('Load balancing configured', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        async function addServerToLB() {
            const token = getCFToken();
            if (!token) {
                showToast('Save Cloudflare token first', 'error');
                return;
            }
            
            const domain = document.getElementById('lb-manage-domain').value.trim();
            const ip = document.getElementById('lb-manage-ip').value.trim();
            
            if (!domain || !ip) {
                showToast('Enter domain and IP', 'error');
                return;
            }
            
            const result = document.getElementById('lb-manage-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Adding server...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/cloudflare/lb/add-server`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        domain,
                        server_ip: ip,
                        cloudflare_token: token,
                    }),
                });
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<span style="color: var(--success);">‚úÖ ${data.message}</span>`;
                    showToast('Server added', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        async function removeServerFromLB() {
            const token = getCFToken();
            if (!token) {
                showToast('Save Cloudflare token first', 'error');
                return;
            }
            
            const domain = document.getElementById('lb-manage-domain').value.trim();
            const ip = document.getElementById('lb-manage-ip').value.trim();
            
            if (!domain || !ip) {
                showToast('Enter domain and IP', 'error');
                return;
            }
            
            const result = document.getElementById('lb-manage-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Removing server...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/cloudflare/lb/remove-server`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        domain,
                        server_ip: ip,
                        cloudflare_token: token,
                    }),
                });
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<span style="color: var(--success);">‚úÖ ${data.message}</span>`;
                    showToast('Server removed', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        async function listLBServers() {
            const token = getCFToken();
            if (!token) {
                showToast('Save Cloudflare token first', 'error');
                return;
            }
            
            const domain = document.getElementById('lb-manage-domain').value.trim();
            if (!domain) {
                showToast('Enter domain', 'error');
                return;
            }
            
            const result = document.getElementById('lb-manage-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Loading...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/cloudflare/lb/servers?domain=${encodeURIComponent(domain)}&cloudflare_token=${encodeURIComponent(token)}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const ipList = data.server_ips.map(ip => `<li>${ip}</li>`).join('');
                    result.innerHTML = `
                        <div style="color: var(--success); margin-bottom: 8px;">
                            ${data.server_count} server(s) for ${domain}
                        </div>
                        <ul style="margin: 0 0 0 16px; font-size: 0.9rem;">${ipList || '<li>No servers</li>'}</ul>
                    `;
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        // =============================================================================
        // Nginx Load Balancer Functions
        // =============================================================================
        
        function parseBackends(text) {
            // Parse "10.0.0.1:8000, 10.0.0.2:8000" into [{ip, port}]
            return text.split(',')
                .map(s => s.trim())
                .filter(s => s)
                .map(s => {
                    const parts = s.split(':');
                    return {
                        ip: parts[0],
                        port: parseInt(parts[1]) || 8000
                    };
                });
        }
        
        async function setupNginxLB(e) {
            e.preventDefault();
            const doToken = getLocalDoToken();
            if (!doToken) {
                showToast('Save DO token first', 'error');
                return;
            }
            
            const name = document.getElementById('nginx-lb-name').value.trim();
            const serverIp = document.getElementById('nginx-lb-server').value.trim();
            const backendsText = document.getElementById('nginx-lb-backends').value.trim();
            const domain = document.getElementById('nginx-lb-domain').value.trim();
            const method = document.getElementById('nginx-lb-method').value;
            
            if (!name || !serverIp || !backendsText) {
                showToast('Fill in required fields', 'error');
                return;
            }
            
            const backends = parseBackends(backendsText);
            if (backends.length === 0) {
                showToast('Enter at least one backend', 'error');
                return;
            }
            
            const result = document.getElementById('nginx-lb-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Setting up nginx LB...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/nginx/lb`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        server_ip: serverIp,
                        backends,
                        do_token: doToken,
                        listen_port: 80,
                        domain: domain || null,
                        lb_method: method,
                    }),
                });
                const data = await response.json();
                
                if (data.success) {
                    const backendList = backends.map(b => `<li>${b.ip}:${b.port}</li>`).join('');
                    result.innerHTML = `
                        <div style="color: var(--success);">‚úÖ ${data.message}</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">
                            <strong>Backends:</strong>
                            <ul style="margin: 4px 0 0 16px;">${backendList}</ul>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem;">
                            Point your domain to <code>${serverIp}</code> for traffic to be load-balanced.
                        </div>
                    `;
                    showToast('Nginx LB configured', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        async function updateNginxLB() {
            const doToken = getLocalDoToken();
            if (!doToken) {
                showToast('Save DO token first', 'error');
                return;
            }
            
            const name = document.getElementById('nginx-lb-manage-name').value.trim();
            const serverIp = document.getElementById('nginx-lb-manage-server').value.trim();
            
            if (!name || !serverIp) {
                showToast('Enter LB name and server IP', 'error');
                return;
            }
            
            // Prompt for new backends
            const backendsText = prompt('Enter new backends (IP:port, comma-separated):', '');
            if (!backendsText) return;
            
            const backends = parseBackends(backendsText);
            if (backends.length === 0) {
                showToast('Enter at least one backend', 'error');
                return;
            }
            
            const result = document.getElementById('nginx-lb-manage-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Updating...</span>';
            
            try {
                const response = await fetch(`${API_BASE}/infra/nginx/lb`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        server_ip: serverIp,
                        backends,
                        do_token: doToken,
                    }),
                });
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<span style="color: var(--success);">‚úÖ ${data.message}</span>`;
                    showToast('Nginx LB updated', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        async function deleteNginxLB() {
            const doToken = getLocalDoToken();
            if (!doToken) {
                showToast('Save DO token first', 'error');
                return;
            }
            
            const name = document.getElementById('nginx-lb-manage-name').value.trim();
            const serverIp = document.getElementById('nginx-lb-manage-server').value.trim();
            
            if (!name || !serverIp) {
                showToast('Enter LB name and server IP', 'error');
                return;
            }
            
            if (!confirm(`Delete nginx LB '${name}'?`)) return;
            
            const result = document.getElementById('nginx-lb-manage-result');
            result.innerHTML = '<span style="color: var(--text-muted);">Deleting...</span>';
            
            try {
                const response = await fetch(
                    `${API_BASE}/infra/nginx/lb?name=${encodeURIComponent(name)}&server_ip=${encodeURIComponent(serverIp)}&do_token=${encodeURIComponent(doToken)}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${state.token}` },
                    }
                );
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<span style="color: var(--success);">‚úÖ ${data.message}</span>`;
                    showToast('Nginx LB deleted', 'success');
                } else {
                    result.innerHTML = `<span style="color: var(--danger);">‚ùå ${data.detail || 'Failed'}</span>`;
                }
            } catch (err) {
                result.innerHTML = `<span style="color: var(--danger);">‚ùå ${err.message}</span>`;
            }
        }
        
        // =============================================================================
        // Modal & Toast
        // =============================================================================
        
        function showModal(title, content, options = {}) {
            const width = options.width || '480px';
            document.getElementById('modals').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target === this) closeModal()">
                    <div class="modal" style="max-width: ${width};">
                        <div class="modal-header">
                            <span class="card-title">${title}</span>
                            <button class="btn btn-ghost btn-sm" onclick="closeModal()">‚úï</button>
                        </div>
                        <div class="modal-body">${content}</div>
                    </div>
                </div>
            `;
        }
        
        function closeModal() {
            document.getElementById('modals').innerHTML = '';
        }
        
        function toggleDockerfile() {
            const content = document.getElementById('dockerfile-content');
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }
        
        // Store build context for retry after manual config
        let pendingBuild = null;
        
        function showDockerfileModal(dockerfileResult, buildContext) {
            pendingBuild = buildContext;
            const { dockerfile, source, files = [], subdirs = [] } = dockerfileResult;
            
            const sourceLabel = {
                'existing': 'üìÅ From project',
                'generated': '‚ú® Auto-generated', 
                'template': 'üìù Template'
            }[source] || source;
            
            const filesHint = files.length > 0 
                ? `<span style="font-size: 0.75rem; color: var(--text-muted);">Files: ${files.slice(0, 8).join(', ')}${files.length > 8 ? '...' : ''}</span>`
                : '';
            
            showModal('üê≥ Dockerfile', `
                <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center;">
                    <span class="badge ${source === 'existing' ? 'badge-success' : source === 'generated' ? 'badge-warning' : 'badge-info'}">${sourceLabel}</span>
                    ${filesHint}
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 280px; gap: 16px;">
                    <!-- Dockerfile textarea -->
                    <div>
                        <textarea id="dockerfile-editor" 
                            style="width: 100%; height: 280px; font-family: monospace; font-size: 12px; 
                                   background: var(--bg-input); border: 1px solid var(--border); 
                                   border-radius: 4px; padding: 12px; resize: vertical;"
                            spellcheck="false">${dockerfile || ''}</textarea>
                    </div>
                    
                    <!-- Helper form -->
                    <div style="background: var(--bg-input); border-radius: 8px; padding: 12px;">
                        <div style="font-size: 0.75rem; font-weight: 600; margin-bottom: 12px; color: var(--text-muted);">Quick Edit</div>
                        
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="font-size: 0.75rem;">FROM</label>
                            <select id="df-from" style="font-size: 0.85rem;" onchange="updateDockerfileFromForm()">
                                <option value="python:3.11-slim">python:3.11-slim</option>
                                <option value="python:3.12-slim">python:3.12-slim</option>
                                <option value="node:20-alpine">node:20-alpine</option>
                                <option value="node:18-alpine">node:18-alpine</option>
                                <option value="golang:1.21-alpine">golang:1.21-alpine</option>
                                <option value="nginx:alpine">nginx:alpine (static)</option>
                                <option value="local/base:latest">local/base:latest (custom snapshot only)</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="font-size: 0.75rem;">WORKDIR</label>
                            <input type="text" id="df-workdir" value="/app" style="font-size: 0.85rem;" oninput="updateDockerfileFromForm()">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="font-size: 0.75rem;">RUN (install)</label>
                            <input type="text" id="df-run" placeholder="pip install -r requirements.txt" style="font-size: 0.85rem;" oninput="updateDockerfileFromForm()">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="font-size: 0.75rem;">EXPOSE</label>
                            <input type="text" id="df-expose" value="8000" style="font-size: 0.85rem;" oninput="updateDockerfileFromForm()">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 8px;">
                            <label style="font-size: 0.75rem;">CMD</label>
                            <input type="text" id="df-cmd" placeholder='["python", "main.py"]' style="font-size: 0.85rem;" oninput="updateDockerfileFromForm()">
                        </div>
                        
                        <button class="btn btn-ghost btn-sm" style="width: 100%; margin-top: 8px;" onclick="parseDockerfileToForm()">
                            ‚Üª Parse from text
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                    <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="buildWithDockerfile()">üöÄ Build & Deploy</button>
                </div>
            `, { width: '720px' });
            
            // Parse initial dockerfile to populate form
            setTimeout(() => parseDockerfileToForm(), 100);
        }
        
        function parseDockerfileToForm() {
            const text = document.getElementById('dockerfile-editor').value;
            const lines = text.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('FROM ')) {
                    const val = trimmed.substring(5).trim().split(' ')[0]; // Handle "FROM x AS y"
                    const select = document.getElementById('df-from');
                    // Try to select, or leave as-is if custom value
                    for (let opt of select.options) {
                        if (opt.value === val) { select.value = val; break; }
                    }
                } else if (trimmed.startsWith('WORKDIR ')) {
                    document.getElementById('df-workdir').value = trimmed.substring(8).trim();
                } else if (trimmed.startsWith('RUN ') && !trimmed.includes('COPY')) {
                    // Only capture first RUN that looks like install
                    const existing = document.getElementById('df-run').value;
                    if (!existing) {
                        document.getElementById('df-run').value = trimmed.substring(4).trim();
                    }
                } else if (trimmed.startsWith('EXPOSE ')) {
                    document.getElementById('df-expose').value = trimmed.substring(7).trim();
                } else if (trimmed.startsWith('CMD ')) {
                    document.getElementById('df-cmd').value = trimmed.substring(4).trim();
                }
            }
        }
        
        function updateDockerfileFromForm() {
            const fromVal = document.getElementById('df-from').value;
            const workdir = document.getElementById('df-workdir').value || '/app';
            const run = document.getElementById('df-run').value;
            const expose = document.getElementById('df-expose').value || '8000';
            const cmd = document.getElementById('df-cmd').value;
            
            let dockerfile = `FROM ${fromVal}\nWORKDIR ${workdir}\nCOPY . .\n`;
            if (run) dockerfile += `RUN ${run}\n`;
            dockerfile += `EXPOSE ${expose}\n`;
            if (cmd) dockerfile += `CMD ${cmd}\n`;
            
            document.getElementById('dockerfile-editor').value = dockerfile;
        }
        
        async function buildWithDockerfile() {
            const dockerfile = document.getElementById('dockerfile-editor').value;
            
            if (!dockerfile.trim()) {
                showToast('Dockerfile cannot be empty', 'error');
                return;
            }
            
            closeModal();
            
            if (!pendingBuild) {
                showToast('Build context lost', 'error');
                return;
            }
            
            const { serverIp, name, port, envVars, log, progress } = pendingBuild;
            
            try {
                log('üî® Building Docker image...');
                log('üìÑ Dockerfile:\n' + dockerfile.split('\n').map(l => '   ' + l).join('\n'));
                
                const buildResult = await doBuild(serverIp, name, dockerfile, log);
                
                log('‚úÖ Image built');
                progress(75);
                
                // Run container
                await runContainer(serverIp, name, `${name}:latest`, port, envVars, log);
                progress(100);
                
                log('‚úÖ Deployment complete!');
                showToast('Deployed successfully!', 'success');
            } catch (err) {
                log('‚ùå Error: ' + err.message);
                showToast(err.message, 'error');
            }
            
            pendingBuild = null;
        }
        
        function formatCmd(cmd) {
            // Convert "uvicorn main:app --host 0.0.0.0" to ["uvicorn", "main:app", "--host", "0.0.0.0"]
            const parts = cmd.match(/(?:[^\s"]+|"[^"]*")+/g) || [cmd];
            return JSON.stringify(parts);
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type === 'info' ? 'success' : type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        // =============================================================================
        // Init
        // =============================================================================
        
        async function initApp() {
            if (!state.token) {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                return;
            }
            
            try {
                state.user = await api('GET', '/auth/me');
                document.getElementById('user-email').textContent = state.user.email;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                checkDOToken();
                checkCFToken();
                await loadServers();
                await loadSnapshots();
                await loadProjectDropdowns();  // Populate project dropdowns
                toggleDeploySource();  // Initialize deploy form visibility
            } catch (err) {
                console.error('Init failed:', err);
                logout();
            }
        }
        
        async function loadProjectDropdowns() {
            try {
                const result = await api('GET', '/infra/projects');
                const projects = result.projects || [];
                
                // Update server project filter
                const serverProjectSelect = document.getElementById('server-project-filter');
                if (serverProjectSelect) {
                    serverProjectSelect.innerHTML = '<option value="">All Projects</option>' + 
                        projects.map(p => `<option value="${p}">${p}</option>`).join('');
                }
                
                // Update logs project filter
                const logsProjectSelect = document.getElementById('logs-project-filter');
                if (logsProjectSelect) {
                    logsProjectSelect.innerHTML = '<option value="">All Projects</option>' + 
                        projects.map(p => `<option value="${p}">${p}</option>`).join('');
                }
            } catch (err) {
                console.error('Failed to load projects:', err);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => initApp());
    </script>
</body>
</html>
